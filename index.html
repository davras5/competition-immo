<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nachhaltigkeit Evaluation Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .mapboxgl-map {
            border-radius: 0.5rem;
        }
        .mapboxgl-ctrl-attrib {
            font-size: 10px !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============ DESIGN TOKENS ============
        // Centralized design system for consistent UI
        const designTokens = {
            // Color palette
            colors: {
                primary: {
                    50: 'emerald-50',
                    100: 'emerald-100',
                    500: 'emerald-500',
                    600: 'emerald-600',
                    700: 'emerald-700',
                },
                surface: {
                    base: 'slate-50',      // Page background
                    elevated: 'white',      // Cards, modals
                    sunken: 'slate-100',    // Inset areas, sidebar
                    overlay: 'black/50',    // Modal backdrop
                },
                text: {
                    primary: 'slate-900',
                    secondary: 'slate-600',
                    tertiary: 'slate-500',
                    disabled: 'slate-400',
                    inverse: 'white',
                },
                border: {
                    default: 'slate-200',
                    subtle: 'slate-100',
                    focus: 'emerald-500',
                },
            },
            // Status colors (unified)
            status: {
                active: { bg: 'bg-amber-100', text: 'text-amber-700', dot: 'bg-amber-400', icon: 'text-amber-600' },
                completed: { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'bg-emerald-400', icon: 'text-emerald-600' },
                draft: { bg: 'bg-slate-100', text: 'text-slate-600', dot: 'bg-slate-400', icon: 'text-slate-500' },
                warning: { bg: 'bg-amber-100', text: 'text-amber-700', dot: 'bg-amber-400', icon: 'text-amber-600' },
                error: { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500', icon: 'text-red-600' },
                info: { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-400', icon: 'text-blue-600' },
                success: { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'bg-emerald-400', icon: 'text-emerald-600' },
            },
            // Spacing scale (based on 4px grid)
            spacing: {
                xs: '1',    // 4px
                sm: '2',    // 8px
                md: '3',    // 12px
                lg: '4',    // 16px
                xl: '5',    // 20px
                '2xl': '6', // 24px
                '3xl': '8', // 32px
            },
            // Border radius scale
            radius: {
                sm: 'rounded',
                md: 'rounded-lg',
                lg: 'rounded-xl',
                xl: 'rounded-2xl',
                full: 'rounded-full',
            },
            // Shadow scale
            shadow: {
                sm: 'shadow-sm',
                md: 'shadow',
                lg: 'shadow-lg',
                xl: 'shadow-xl',
            },
            // Typography scale
            typography: {
                h1: 'text-2xl font-bold text-slate-900',
                h2: 'text-xl font-semibold text-slate-900',
                h3: 'text-lg font-semibold text-slate-900',
                h4: 'text-sm font-semibold text-slate-700',
                body: 'text-sm text-slate-600',
                bodyLarge: 'text-base text-slate-600',
                small: 'text-xs text-slate-500',
                label: 'text-xs text-slate-500 uppercase tracking-wide',
                link: 'text-sm text-emerald-600 hover:text-emerald-700 font-medium',
            },
            // Transitions
            transition: {
                fast: 'transition-all duration-150',
                normal: 'transition-all duration-200',
                slow: 'transition-all duration-300',
            },
        };

        // ============ BASE COMPONENTS ============

        // Icon component with accessibility
        const MaterialIcon = ({ name, className = "", size = 20, label }) => (
            <span
                className={`material-symbols-outlined ${className}`}
                style={{ fontSize: size, lineHeight: 1, userSelect: 'none' }}
                role={label ? "img" : "presentation"}
                aria-label={label}
                aria-hidden={!label}
            >
                {name}
            </span>
        );

        // Button component with variants
        const Button = ({
            children,
            variant = 'primary',
            size = 'md',
            icon,
            iconPosition = 'left',
            className = '',
            disabled = false,
            ...props
        }) => {
            const variants = {
                primary: 'bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500',
                secondary: 'bg-slate-100 text-slate-700 hover:bg-slate-200 focus:ring-slate-400',
                ghost: 'bg-transparent text-slate-600 hover:bg-slate-100 focus:ring-slate-400',
                danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
                dangerGhost: 'bg-transparent text-red-600 hover:bg-red-50 focus:ring-red-400',
            };
            const sizes = {
                sm: 'px-3 py-1.5 text-xs gap-1.5',
                md: 'px-4 py-2 text-sm gap-2',
                lg: 'px-5 py-2.5 text-base gap-2',
            };
            return (
                <button
                    className={`
                        inline-flex items-center justify-center font-medium rounded-lg
                        transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2
                        disabled:opacity-50 disabled:cursor-not-allowed
                        ${variants[variant]} ${sizes[size]} ${className}
                    `}
                    disabled={disabled}
                    {...props}
                >
                    {icon && iconPosition === 'left' && <MaterialIcon name={icon} size={size === 'sm' ? 14 : size === 'lg' ? 20 : 16} />}
                    {children}
                    {icon && iconPosition === 'right' && <MaterialIcon name={icon} size={size === 'sm' ? 14 : size === 'lg' ? 20 : 16} />}
                </button>
            );
        };

        // Status Badge component
        const StatusBadge = ({ status, label, showDot = true, size = 'md' }) => {
            const statusStyles = designTokens.status[status] || designTokens.status.draft;
            const sizes = {
                sm: 'px-2 py-0.5 text-xs',
                md: 'px-2.5 py-1 text-xs',
                lg: 'px-3 py-1.5 text-sm',
            };
            return (
                <span className={`inline-flex items-center gap-1.5 font-medium rounded-full ${statusStyles.bg} ${statusStyles.text} ${sizes[size]}`}>
                    {showDot && <span className={`w-1.5 h-1.5 rounded-full ${statusStyles.dot}`} />}
                    {label}
                </span>
            );
        };

        // Avatar component
        const UserAvatar = ({ name, src, size = 'md', className = '' }) => {
            const sizes = {
                sm: 'w-6 h-6 text-xs',
                md: 'w-8 h-8 text-sm',
                lg: 'w-10 h-10 text-base',
                xl: 'w-12 h-12 text-lg',
            };
            const getInitials = (name) => {
                if (!name) return '?';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };
            if (src) {
                return (
                    <img
                        src={src}
                        alt={name}
                        className={`${sizes[size]} rounded-full object-cover ${className}`}
                    />
                );
            }
            return (
                <div
                    className={`${sizes[size]} rounded-full bg-slate-200 flex items-center justify-center font-medium text-slate-600 ${className}`}
                    title={name}
                >
                    {getInitials(name)}
                </div>
            );
        };

        // Content Card component
        const ContentCard = ({ title, actions, children, className = '', noPadding = false }) => (
            <div className={`bg-white rounded-xl border border-slate-200 overflow-hidden ${className}`}>
                {title && (
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
                        <h3 className="font-semibold text-slate-900">{title}</h3>
                        {actions && <div className="flex items-center gap-2">{actions}</div>}
                    </div>
                )}
                <div className={noPadding ? '' : 'p-5'}>
                    {children}
                </div>
            </div>
        );

        // Statistic Card component
        const StatisticCard = ({ icon, iconBg = 'bg-slate-100', iconColor = 'text-slate-600', value, label, valueColor = 'text-slate-900' }) => (
            <div className="bg-white rounded-xl p-5 border border-slate-200">
                <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 ${iconBg} rounded-lg flex items-center justify-center`}>
                        <MaterialIcon name={icon} size={20} className={iconColor} />
                    </div>
                    <div>
                        <div className={`text-2xl font-bold ${valueColor}`}>{value}</div>
                        <div className="text-sm text-slate-500">{label}</div>
                    </div>
                </div>
            </div>
        );

        // Empty State Placeholder component
        const EmptyStatePlaceholder = ({ icon, title, description, action }) => (
            <div className="flex flex-col items-center justify-center py-12 px-4 text-center">
                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                    <MaterialIcon name={icon} size={32} className="text-slate-400" />
                </div>
                <h3 className="text-lg font-medium text-slate-900 mb-1">{title}</h3>
                {description && <p className="text-sm text-slate-500 mb-4 max-w-sm">{description}</p>}
                {action}
            </div>
        );

        // Text Input component
        const TextInput = ({ label, error, required, helpText, className = '', ...props }) => (
            <div className={className}>
                {label && (
                    <label className="block text-sm font-medium text-slate-700 mb-1.5">
                        {label} {required && <span className="text-red-500">*</span>}
                    </label>
                )}
                <input
                    className={`
                        w-full px-3 py-2 border rounded-lg text-sm
                        transition-all duration-200
                        focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none
                        ${error ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : 'border-slate-200'}
                    `}
                    aria-invalid={error ? 'true' : undefined}
                    aria-describedby={error ? `${props.id || label}-error` : undefined}
                    {...props}
                />
                {error && <p id={`${props.id || label}-error`} className="mt-1 text-xs text-red-600" role="alert">{error}</p>}
                {helpText && !error && <p className="mt-1 text-xs text-slate-500">{helpText}</p>}
            </div>
        );

        // Select Dropdown component
        const SelectDropdown = ({ label, options = [], error, className = '', ...props }) => (
            <div className={className}>
                {label && (
                    <label className="block text-sm font-medium text-slate-700 mb-1.5">
                        {label}
                    </label>
                )}
                <select
                    className={`
                        w-full px-3 py-2 border rounded-lg text-sm
                        transition-all duration-200
                        focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none
                        ${error ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : 'border-slate-200'}
                    `}
                    {...props}
                >
                    {options.map(opt => (
                        <option key={opt.value || opt} value={opt.value || opt}>
                            {opt.label || opt}
                        </option>
                    ))}
                </select>
                {error && <p className="mt-1 text-xs text-red-600">{error}</p>}
            </div>
        );

        // Label-Value Pair component for data display
        const LabelValuePair = ({ label, children, className = '' }) => (
            <div className={className}>
                <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">{label}</div>
                <div className="text-sm font-medium text-slate-900">{children}</div>
            </div>
        );

        // Progress Bar component
        const ProgressBar = ({ value, max = 100, color = 'emerald', size = 'md', showLabel = false }) => {
            const percentage = Math.min(100, Math.max(0, (value / max) * 100));
            const sizes = { sm: 'h-1', md: 'h-2', lg: 'h-3' };
            const colors = {
                emerald: 'bg-emerald-500',
                amber: 'bg-amber-400',
                red: 'bg-red-500',
                blue: 'bg-blue-500',
            };
            return (
                <div className="w-full">
                    <div className={`${sizes[size]} bg-slate-100 rounded-full overflow-hidden`}>
                        <div
                            className={`h-full rounded-full transition-all duration-300 ${colors[color]}`}
                            style={{ width: `${percentage}%` }}
                        />
                    </div>
                    {showLabel && (
                        <div className="mt-1 text-xs text-slate-500 text-right">{Math.round(percentage)}%</div>
                    )}
                </div>
            );
        };

        const SustainabilityApp = () => {
            const [role, setRole] = useState('admin');
            const [currentProject, setCurrentProject] = useState(null); // null = gallery view, project object = project view
            const [galleryViewMode, setGalleryViewMode] = useState('grid'); // grid, list, map
            const [sidebarView, setSidebarView] = useState('overview'); // overview, evaluation, model3d, comparison
            const [selectedVariant, setSelectedVariant] = useState(0);
            const [selectedVariantsForCompare, setSelectedVariantsForCompare] = useState([0, 1, 2, 3, 4]); // For comparison view
            const [isEditMode, setIsEditMode] = useState(false);
            const [has3DModel, setHas3DModel] = useState(true);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

            // State for storing criterion ratings and comments per variant
            // Structure: { variantIndex: { criterionId: { rating: 'positive'|'neutral'|'negative', comment: string } } }
            const [criteriaData, setCriteriaData] = useState({});

            // Function to update a criterion's rating
            const updateCriterionRating = (variantIndex, criterionId, newRating) => {
                setCriteriaData(prev => ({
                    ...prev,
                    [variantIndex]: {
                        ...prev[variantIndex],
                        [criterionId]: {
                            ...prev[variantIndex]?.[criterionId],
                            rating: newRating
                        }
                    }
                }));
            };

            // Function to update a criterion's comment
            const updateCriterionComment = (variantIndex, criterionId, newComment) => {
                setCriteriaData(prev => ({
                    ...prev,
                    [variantIndex]: {
                        ...prev[variantIndex],
                        [criterionId]: {
                            ...prev[variantIndex]?.[criterionId],
                            comment: newComment
                        }
                    }
                }));
            };

            // Variants data with images
            const variants = [
                { id: 1, name: 'Baukontor', firm: 'Baukontor AG', code: '1001', 
                thumbnail: 'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=400&h=300&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&h=600&fit=crop',
                ]
                },
                { id: 2, name: 'Berrel_Kräutler', firm: 'Berrel Kräutler', code: '1002',
                thumbnail: 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1480074568708-e7b720bb3f09?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1494526585095-c41746248156?w=800&h=600&fit=crop',
                ]
                },
                { id: 3, name: 'Meier_Hug', firm: 'Meier und Hug', code: '1003',
                thumbnail: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400&h=300&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1448630360428-65456885c650?w=800&h=600&fit=crop',
                ]
                },
                { id: 4, name: 'Spillmann_Echsle', firm: 'Spillmann Echsle', code: '1004',
                thumbnail: 'https://images.unsplash.com/photo-1480074568708-e7b720bb3f09?w=400&h=300&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1480074568708-e7b720bb3f09?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1494526585095-c41746248156?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&h=600&fit=crop',
                ]
                },
                { id: 5, name: 'Z2G', firm: 'Planer', code: '1005',
                thumbnail: 'https://images.unsplash.com/photo-1494526585095-c41746248156?w=400&h=300&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1494526585095-c41746248156?w=800&h=600&fit=crop',
                ]
                },
            ];

            // Projects data
            const projects = [
                {
                    id: 1,
                    name: 'Badenerstrasse 501',
                    address: 'Badenerstrasse 501, 8048 Zürich',
                    usageType: 'Wohnen',
                    status: 'active',
                    statusLabel: 'Bewertung läuft',
                    variantCount: 5,
                    evaluatedCount: 2,
                    thumbnail: 'https://images.unsplash.com/photo-1486325212027-8081e485255e?w=400&h=300&fit=crop',
                    framework: 'SNAP',
                    phase: 'Vorprojekt',
                    coordinates: { lat: 47.3769, lng: 8.5017 },
                    lastUpdated: '18.11.2024'
                },
                {
                    id: 2,
                    name: 'Europaallee Baufeld G',
                    address: 'Europaallee 21, 8004 Zürich',
                    usageType: 'Büro / Gewerbe',
                    status: 'completed',
                    statusLabel: 'Abgeschlossen',
                    variantCount: 3,
                    evaluatedCount: 3,
                    thumbnail: 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop',
                    framework: 'SNAP',
                    phase: 'Bauprojekt',
                    coordinates: { lat: 47.3782, lng: 8.5314 },
                    lastUpdated: '02.10.2024'
                },
                {
                    id: 3,
                    name: 'Glattpark Mitte',
                    address: 'Lindberghplatz 1, 8152 Opfikon',
                    usageType: 'Wohnen / Gewerbe',
                    status: 'active',
                    statusLabel: 'In Bearbeitung',
                    variantCount: 4,
                    evaluatedCount: 1,
                    thumbnail: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400&h=300&fit=crop',
                    framework: 'SNBS',
                    phase: 'Vorprojekt',
                    coordinates: { lat: 47.4234, lng: 8.5687 },
                    lastUpdated: '25.11.2024'
                },
                {
                    id: 4,
                    name: 'Hardturm Areal',
                    address: 'Pfingstweidstrasse 100, 8005 Zürich',
                    usageType: 'Stadion / Wohnen',
                    status: 'draft',
                    statusLabel: 'Entwurf',
                    variantCount: 6,
                    evaluatedCount: 0,
                    thumbnail: 'https://images.unsplash.com/photo-1480074568708-e7b720bb3f09?w=400&h=300&fit=crop',
                    framework: 'SNAP',
                    phase: 'Machbarkeit',
                    coordinates: { lat: 47.3912, lng: 8.5043 },
                    lastUpdated: '10.11.2024'
                },
                {
                    id: 5,
                    name: 'Greencity Süd',
                    address: 'Maneggstrasse 50, 8041 Zürich',
                    usageType: 'Wohnen',
                    status: 'completed',
                    statusLabel: 'Abgeschlossen',
                    variantCount: 2,
                    evaluatedCount: 2,
                    thumbnail: 'https://images.unsplash.com/photo-1494526585095-c41746248156?w=400&h=300&fit=crop',
                    framework: 'Minergie-ECO',
                    phase: 'Realisierung',
                    coordinates: { lat: 47.3456, lng: 8.5234 },
                    lastUpdated: '15.09.2024'
                },
                {
                    id: 6,
                    name: 'Seefeld Quartier',
                    address: 'Seefeldstrasse 123, 8008 Zürich',
                    usageType: 'Wohnen',
                    status: 'active',
                    statusLabel: 'Bewertung läuft',
                    variantCount: 3,
                    evaluatedCount: 2,
                    thumbnail: 'https://images.unsplash.com/photo-1448630360428-65456885c650?w=400&h=300&fit=crop',
                    framework: 'SNAP',
                    phase: 'Vorprojekt',
                    coordinates: { lat: 47.3543, lng: 8.5567 },
                    lastUpdated: '20.11.2024'
                }
            ];

            // SNAP themes
            const themes = {
                functionality: {
                id: 'functionality',
                name: 'Funktionalität',
                color: 'blue',
                kennwerte: [
                    { id: 'fk-01', label: 'Fahrradstellplätze (Anzahl)', unit: 'St.' },
                    { id: 'fk-02', label: 'Entfernung Fahrrad → Eingang', unit: 'm' },
                    { id: 'fk-03', label: 'Anteil barrierefreie Wohnungen', unit: '%' },
                ],
                kriterien: [
                    { id: '01', name: 'Erschliessung', 
                    desc: 'Vorfahrt, Ver-/Entsorgung, TG-Erschliessung, Fahrradstellplätze, Haupteingang, interne Wege' },
                    { id: '02', name: 'Öffentliche Zugänglichkeit',
                    desc: 'Öffentliche Zugänglichkeit Gebäude + Grundstück, bauliche Voraussetzungen' },
                    { id: '03', name: 'Barrierefreiheit',
                    desc: 'Barrierefreiheit Gebäude und Aussenanlagen' },
                    { id: '04', name: 'Kommunikationsfördernde Flächen',
                    desc: 'Angebot im Gebäude und im Aussenraum' },
                ]
                },
                comfort: {
                id: 'comfort',
                name: 'Komfort & Gesundheit',
                color: 'emerald',
                kennwerte: [
                    { id: 'ko-01', label: 'Gesamtfensterflächenanteil', unit: '%' },
                    { id: 'ko-02', label: 'Fensterflächenanteil Ost/West', unit: '%' },
                    { id: 'ko-03', label: 'Mittlere Raumtiefe Hauptnutzung', unit: 'm' },
                ],
                kriterien: [
                    { id: '05', name: 'Sicherheit',
                    desc: 'Brandschutz, projektspezifische Sicherheit, Übersichtlichkeit und Orientierung' },
                    { id: '06', name: 'Schallschutz',
                    desc: 'Orientierung schutzbedürftiger Räume, bauliche Massnahmen, Nutzungskonflikte' },
                    { id: '07', name: 'Tageslicht',
                    desc: 'Tageslichtversorgung Hauptnutzungen, Raumtiefe, Sturzausbildung, Sichtbeziehungen' },
                    { id: '08', name: 'Raumklima',
                    desc: 'Orientierung, Sonnenschutzkonzept, Brüstungsbereich, bauliche Massnahmen' },
                ]
                },
                economics: {
                id: 'economics',
                name: 'Wirtschaftlichkeit',
                color: 'amber',
                kennwerte: [
                    { id: 'wi-01', label: 'NF/BGF (Flächeneffizienz)', unit: '' },
                    { id: 'wi-02', label: 'BRI/BGF (Volumeneffizienz)', unit: '' },
                    { id: 'wi-03', label: 'A/V-Verhältnis', unit: '' },
                    { id: 'wi-04', label: 'Hüllflächenanteil', unit: '%' },
                ],
                kriterien: [
                    { id: '09', name: 'Flächeneffizienz',
                    desc: 'NF/BGF, BRI/BGF Verhältnisse' },
                    { id: '10', name: 'Nutzungsflexibilität',
                    desc: 'Lichte Raumhöhe, Umnutzungsfähigkeit, Teilbarkeit, Nutzung durch Dritte' },
                    { id: '11', name: 'Lebenszykluskosten',
                    desc: 'Kubatur, Fassade, Energiebedarf, Energiekosten, Dauerhaftigkeit' },
                ]
                },
                resources: {
                id: 'resources',
                name: 'Ressourcen & Energie',
                color: 'violet',
                kennwerte: [
                    { id: 're-01', label: 'Versiegelungsgrad Grundstück', unit: '%' },
                    { id: 're-02', label: 'Primärenergiebedarf', unit: '%' },
                    { id: 're-03', label: 'Endenergiebedarf', unit: 'kWh/m²a' },
                    { id: 're-04', label: 'Energiebedarfsdeckung Solar (Strom)', unit: '%' },
                    { id: 're-05', label: 'Energiebedarfsdeckung Solar (Wärme)', unit: '%' },
                ],
                kriterien: [
                    { id: '12', name: 'Flächenversiegelung',
                    desc: 'Versiegelungsgrad, Gründach, unterbaute Fläche, Ausgleichsmassnahmen' },
                    { id: '13', name: 'Baustoffe',
                    desc: 'BRI, Hüllflächenanteil, Baumasse unter Gelände, nachwachsende Rohstoffe' },
                    { id: '14', name: 'Endenergiebedarf',
                    desc: 'Heizwärmebedarf, A/V, solare Gewinne, Kunstlichtbedarf' },
                    { id: '15', name: 'Energiebedarfsdeckung',
                    desc: 'Solartechnik Strom/Wärme, Gebäudeintegration, lokale Energiepotenziale' },
                ]
                }
            };

            // Generate mock data for variants
            const generateKennwertData = (variantIndex, kennwerte) => {
                return kennwerte.map((k, i) => {
                const baseValue = 50 + (variantIndex * 7 + i * 13) % 50;
                const avgValue = 60 + (i * 11) % 30;
                const rank = ((variantIndex + i) % 5) + 1;
                const delta = baseValue - avgValue;
                return {
                    ...k,
                    value: baseValue,
                    avg: avgValue,
                    rank: rank,
                    total: 5,
                    delta: delta
                };
                });
            };

            const generateKriterienData = (variantIndex, kriterien) => {
                const defaultRatings = ['positive', 'neutral', 'negative'];
                const defaultComments = [
                'Vorfahrt eingeschränkt berücksichtigt; Ver- und Entsorgung bedingt funktionstüchtig; günstige Positionierung Fahrradabstellplätze; Anzahl erfüllt; Haupteingang erkennbar; kurze interne Wege;',
                'Gebäude eingeschränkt barrierefrei; Barrierefreiheit Aussenraum k. A. / unklar (Freitreppe);',
                'vielfältiges Angebot im Gebäude (Ausstellung, Präsentation); vielfältiges Angebot im Aussenraum;',
                'Brandschutzanforderungen berücksichtigt; Sicherheitsanforderungen teilw. erfüllt; überwiegend übersichtliche Wege;',
                'ungünstige Orientierung schutzbedürftiger Räume; ungünstige Orientierung privater Freiräume; bauliche Schallschutzmassnahmen teilw. berücksichtigt; ggf. Nutzungskonflikte;',
                'hoher Gesamtfensterflächenanteil; mässige Tageslichtversorgung Hauptnutzungen; opake Sturzausbildung; mässige TL-Versorgung Flure; Sichtbeziehungen zum Aussenraum;',
                ];

                return kriterien.map((k, i) => {
                // Check if we have stored data for this criterion
                const storedData = criteriaData[variantIndex]?.[k.id];
                const defaultRating = defaultRatings[(variantIndex + i) % 3];
                const defaultComment = defaultComments[(variantIndex + i) % defaultComments.length];

                return {
                    ...k,
                    rating: storedData?.rating || defaultRating,
                    score: [33, 66][(variantIndex + i) % 2],
                    comment: storedData?.comment !== undefined ? storedData.comment : defaultComment
                };
                });
            };

            const currentVariant = variants[selectedVariant];

            // ============ PROJECTS GALLERY ============
            const ProjectCard = ({ project, onClick }) => (
                <div
                    onClick={onClick}
                    className="bg-white rounded-xl border border-slate-200 overflow-hidden cursor-pointer hover:shadow-lg hover:border-emerald-300 transition-all duration-200 group focus-within:ring-2 focus-within:ring-emerald-500"
                    tabIndex={0}
                    role="button"
                    aria-label={`Projekt ${project.name} öffnen`}
                    onKeyDown={(e) => e.key === 'Enter' && onClick()}
                >
                    {/* Thumbnail */}
                    <div className="h-40 relative overflow-hidden">
                        <img
                            src={project.thumbnail}
                            alt={project.name}
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
                        <div className="absolute top-3 right-3">
                            <StatusBadge status={project.status} label={project.statusLabel} />
                        </div>
                        <div className="absolute bottom-3 left-3 right-3">
                            <h3 className="text-white font-semibold text-lg truncate">{project.name}</h3>
                            <p className="text-white/80 text-sm truncate">{project.address}</p>
                        </div>
                    </div>

                    {/* Details */}
                    <div className="p-4">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <LabelValuePair label="Nutzung">
                                <span className="truncate block">{project.usageType}</span>
                            </LabelValuePair>
                            <LabelValuePair label="Framework">{project.framework}</LabelValuePair>
                        </div>
                        <div className="flex items-center justify-between pt-3 border-t border-slate-100">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-1.5 text-sm text-slate-600">
                                    <MaterialIcon name="apartment" size={16} className="text-slate-400" />
                                    <span>{project.variantCount} Varianten</span>
                                </div>
                                <div className="flex items-center gap-1.5 text-sm text-slate-600">
                                    <MaterialIcon name="check_circle" size={16} className="text-emerald-500" />
                                    <span>{project.evaluatedCount} bewertet</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const ProjectListRow = ({ project, onClick }) => (
                <tr
                    onClick={onClick}
                    className="hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0 transition-colors duration-150"
                    tabIndex={0}
                    role="button"
                    aria-label={`Projekt ${project.name} öffnen`}
                    onKeyDown={(e) => e.key === 'Enter' && onClick()}
                >
                    <td className="px-4 py-3">
                        <div className="flex items-center gap-3">
                            <div className="w-16 h-12 rounded-lg overflow-hidden flex-shrink-0">
                                <img src={project.thumbnail} alt={project.name} className="w-full h-full object-cover" />
                            </div>
                            <div>
                                <div className="font-medium text-slate-900">{project.name}</div>
                                <div className="text-sm text-slate-500">{project.address}</div>
                            </div>
                        </div>
                    </td>
                    <td className="px-4 py-3 text-sm text-slate-600">{project.usageType}</td>
                    <td className="px-4 py-3 text-sm text-slate-600">{project.framework}</td>
                    <td className="px-4 py-3 text-sm text-slate-600">{project.phase}</td>
                    <td className="px-4 py-3">
                        <StatusBadge status={project.status} label={project.statusLabel} size="sm" />
                    </td>
                    <td className="px-4 py-3 text-sm text-slate-600">{project.variantCount}</td>
                    <td className="px-4 py-3 text-sm text-slate-500">{project.lastUpdated}</td>
                </tr>
            );

            const ProjectGalleryView = () => {
                const [searchQuery, setSearchQuery] = useState('');
                const [statusFilter, setStatusFilter] = useState('all');
                const [usageFilter, setUsageFilter] = useState('all');

                const handleProjectClick = (project) => {
                    setCurrentProject(project);
                    setSidebarView('overview');
                };

                // Filter projects based on search and filters
                const filteredProjects = projects.filter(project => {
                    const matchesSearch = searchQuery === '' ||
                        project.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        project.address.toLowerCase().includes(searchQuery.toLowerCase());
                    const matchesStatus = statusFilter === 'all' || project.status === statusFilter;
                    const matchesUsage = usageFilter === 'all' || project.usageType === usageFilter;
                    return matchesSearch && matchesStatus && matchesUsage;
                });

                // Stats for the gallery
                const totalProjects = projects.length;
                const activeProjects = projects.filter(p => p.status === 'active').length;
                const completedProjects = projects.filter(p => p.status === 'completed').length;

                // Get unique usage types for filter
                const usageTypes = [...new Set(projects.map(p => p.usageType))];

                // View mode toggle button component
                const GalleryModeButton = ({ mode, icon, label }) => (
                    <button
                        onClick={() => setGalleryViewMode(mode)}
                        className={`p-2 rounded-md transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-emerald-500 ${
                            galleryViewMode === mode
                                ? 'bg-white shadow-sm text-emerald-600'
                                : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                        }`}
                        aria-label={label}
                        aria-pressed={galleryViewMode === mode}
                        title={label}
                    >
                        <MaterialIcon name={icon} size={18} />
                    </button>
                );

                return (
                    <div className="flex-1 bg-slate-50">
                        {/* Gallery Header - full width white bg, max-width content */}
                        <div className="bg-white border-b border-slate-200">
                            <div className="max-w-[1400px] mx-auto px-6 py-4">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h1 className="text-2xl font-bold text-slate-900">Projekte</h1>
                                        <p className="text-sm text-slate-500 mt-1">
                                            {filteredProjects.length === totalProjects
                                                ? `${totalProjects} Projekte · ${activeProjects} aktiv · ${completedProjects} abgeschlossen`
                                                : `${filteredProjects.length} von ${totalProjects} Projekten`
                                            }
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {/* View Mode Toggle */}
                                        <div className="flex items-center bg-slate-100 rounded-lg p-1" role="group" aria-label="Ansichtsoptionen">
                                            <GalleryModeButton mode="grid" icon="grid_view" label="Galerieansicht" />
                                            <GalleryModeButton mode="list" icon="view_list" label="Listenansicht" />
                                            <GalleryModeButton mode="map" icon="map" label="Kartenansicht" />
                                        </div>

                                        {/* New Project Button */}
                                        <Button
                                            onClick={() => setIsCreateModalOpen(true)}
                                            icon="add"
                                        >
                                            Neues Projekt
                                        </Button>
                                    </div>
                                </div>

                                {/* Search and Filters */}
                                <div className="flex items-center gap-3">
                                    {/* Search Input */}
                                    <div className="relative flex-1 max-w-md">
                                        <MaterialIcon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input
                                            type="text"
                                            placeholder="Projekt suchen..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                        />
                                        {searchQuery && (
                                            <button
                                                onClick={() => setSearchQuery('')}
                                                className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                                                aria-label="Suche löschen"
                                            >
                                                <MaterialIcon name="close" size={16} />
                                            </button>
                                        )}
                                    </div>

                                    {/* Status Filter */}
                                    <select
                                        value={statusFilter}
                                        onChange={(e) => setStatusFilter(e.target.value)}
                                        className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white"
                                    >
                                        <option value="all">Alle Status</option>
                                        <option value="active">Aktiv</option>
                                        <option value="completed">Abgeschlossen</option>
                                        <option value="draft">Entwurf</option>
                                    </select>

                                    {/* Usage Type Filter */}
                                    <select
                                        value={usageFilter}
                                        onChange={(e) => setUsageFilter(e.target.value)}
                                        className="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white"
                                    >
                                        <option value="all">Alle Nutzungen</option>
                                        {usageTypes.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>

                                    {/* Clear Filters */}
                                    {(searchQuery || statusFilter !== 'all' || usageFilter !== 'all') && (
                                        <button
                                            onClick={() => {
                                                setSearchQuery('');
                                                setStatusFilter('all');
                                                setUsageFilter('all');
                                            }}
                                            className="px-3 py-2 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-1.5"
                                        >
                                            <MaterialIcon name="filter_alt_off" size={16} />
                                            Filter zurücksetzen
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Gallery Content - max width */}
                        <div className="max-w-[1400px] mx-auto p-6">
                            {/* Empty state when no projects match filter */}
                            {filteredProjects.length === 0 ? (
                                <div className="bg-white rounded-xl border p-12 text-center">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <MaterialIcon name="search_off" size={32} className="text-slate-400" />
                                    </div>
                                    <h3 className="text-lg font-medium text-slate-900 mb-2">Keine Projekte gefunden</h3>
                                    <p className="text-sm text-slate-500 mb-4">
                                        Versuchen Sie, Ihre Suchkriterien anzupassen oder Filter zurückzusetzen.
                                    </p>
                                    <button
                                        onClick={() => {
                                            setSearchQuery('');
                                            setStatusFilter('all');
                                            setUsageFilter('all');
                                        }}
                                        className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm font-medium"
                                    >
                                        Filter zurücksetzen
                                    </button>
                                </div>
                            ) : (
                                <>
                                    {galleryViewMode === 'grid' && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {filteredProjects.map(project => (
                                                <ProjectCard
                                                    key={project.id}
                                                    project={project}
                                                    onClick={() => handleProjectClick(project)}
                                                />
                                            ))}
                                        </div>
                                    )}

                                    {galleryViewMode === 'list' && (
                                        <div className="bg-white rounded-xl border overflow-hidden">
                                            <table className="w-full">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr className="text-left text-xs font-medium text-slate-500 uppercase tracking-wide">
                                                        <th className="px-4 py-3">Projekt</th>
                                                        <th className="px-4 py-3">Nutzung</th>
                                                        <th className="px-4 py-3">Framework</th>
                                                        <th className="px-4 py-3">Phase</th>
                                                        <th className="px-4 py-3">Status</th>
                                                        <th className="px-4 py-3">Varianten</th>
                                                        <th className="px-4 py-3">Aktualisiert</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredProjects.map(project => (
                                                        <ProjectListRow
                                                            key={project.id}
                                                            project={project}
                                                            onClick={() => handleProjectClick(project)}
                                                        />
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}

                                    {galleryViewMode === 'map' && (
                                        <div className="bg-white rounded-xl border overflow-hidden h-full min-h-96">
                                            <div className="h-full bg-slate-200 relative">
                                                {/* Map placeholder with project markers */}
                                                <div className="absolute inset-0 bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                                                    <div className="text-center">
                                                        <MaterialIcon name="map" size={48} className="text-slate-400 mx-auto mb-3" />
                                                        <div className="text-lg font-medium text-slate-600">Kartenansicht</div>
                                                        <div className="text-sm text-slate-500 mt-1">Zeigt {filteredProjects.length} Projekte in der Region Zürich</div>
                                                    </div>
                                                </div>

                                                {/* Fake map markers */}
                                                {filteredProjects.map((project, i) => (
                                                    <div
                                                        key={project.id}
                                                        onClick={() => handleProjectClick(project)}
                                                        className="absolute cursor-pointer group"
                                                        style={{
                                                            left: `${20 + (i % 3) * 25 + Math.random() * 10}%`,
                                                            top: `${20 + Math.floor(i / 3) * 30 + Math.random() * 10}%`
                                                        }}
                                                    >
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center shadow-lg transition-transform group-hover:scale-125 ${
                                                            project.status === 'completed' ? 'bg-emerald-500' :
                                                            project.status === 'active' ? 'bg-amber-500' : 'bg-slate-500'
                                                        }`}>
                                                            <MaterialIcon name="location_on" size={16} className="text-white" />
                                                        </div>
                                                        <div className="absolute left-10 top-0 bg-white rounded-lg shadow-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                                            <div className="font-medium text-sm text-slate-900">{project.name}</div>
                                                            <div className="text-xs text-slate-500">{project.variantCount} Varianten</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            // ============ CREATE PROJECT MODAL ============
            const CreateProjectModal = () => {
                const [formData, setFormData] = useState({
                    name: '',
                    address: '',
                    usageType: '',
                    framework: '',
                    phase: ''
                });
                const [errors, setErrors] = useState({});
                const [isSubmitting, setIsSubmitting] = useState(false);

                if (!isCreateModalOpen) return null;

                const usageOptions = [
                    { value: '', label: 'Bitte wählen...' },
                    { value: 'Wohnen', label: 'Wohnen' },
                    { value: 'Büro / Gewerbe', label: 'Büro / Gewerbe' },
                    { value: 'Wohnen / Gewerbe', label: 'Wohnen / Gewerbe' },
                    { value: 'Bildung', label: 'Bildung' },
                    { value: 'Andere', label: 'Andere' }
                ];
                const frameworkOptions = [
                    { value: '', label: 'Bitte wählen...' },
                    { value: 'SNAP', label: 'SNAP' },
                    { value: 'SNBS', label: 'SNBS' },
                    { value: 'Minergie-ECO', label: 'Minergie-ECO' },
                    { value: 'DGNB', label: 'DGNB' }
                ];
                const phaseOptions = [
                    { value: '', label: 'Bitte wählen...' },
                    { value: 'Machbarkeit', label: 'Machbarkeit' },
                    { value: 'Vorprojekt', label: 'Vorprojekt' },
                    { value: 'Bauprojekt', label: 'Bauprojekt' },
                    { value: 'Realisierung', label: 'Realisierung' }
                ];

                const validateForm = () => {
                    const newErrors = {};
                    if (!formData.name.trim()) {
                        newErrors.name = 'Projektname ist erforderlich';
                    }
                    if (!formData.usageType) {
                        newErrors.usageType = 'Bitte wählen Sie einen Nutzungstyp';
                    }
                    if (!formData.framework) {
                        newErrors.framework = 'Bitte wählen Sie ein Framework';
                    }
                    setErrors(newErrors);
                    return Object.keys(newErrors).length === 0;
                };

                const handleSubmit = () => {
                    if (validateForm()) {
                        setIsSubmitting(true);
                        // Simulate submission
                        setTimeout(() => {
                            setIsSubmitting(false);
                            setIsCreateModalOpen(false);
                            setFormData({ name: '', address: '', usageType: '', framework: '', phase: '' });
                        }, 500);
                    }
                };

                const handleClose = () => {
                    setIsCreateModalOpen(false);
                    setFormData({ name: '', address: '', usageType: '', framework: '', phase: '' });
                    setErrors({});
                };

                return (
                    <div
                        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                        role="dialog"
                        aria-modal="true"
                        aria-labelledby="modal-title"
                        onClick={(e) => e.target === e.currentTarget && handleClose()}
                    >
                        <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 animate-in fade-in zoom-in duration-200">
                            {/* Modal Header */}
                            <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <h2 id="modal-title" className="text-lg font-semibold text-slate-900">
                                        Neues Projekt erstellen
                                    </h2>
                                    <p className="text-sm text-slate-500 mt-0.5">
                                        Felder mit <span className="text-red-500">*</span> sind erforderlich
                                    </p>
                                </div>
                                <button
                                    onClick={handleClose}
                                    className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    aria-label="Modal schließen"
                                >
                                    <MaterialIcon name="close" size={20} />
                                </button>
                            </div>

                            {/* Modal Body */}
                            <div className="p-6 space-y-4">
                                <TextInput
                                    label="Projektname"
                                    type="text"
                                    placeholder="z.B. Musterstrasse 123"
                                    autoFocus
                                    required
                                    value={formData.name}
                                    onChange={(e) => {
                                        setFormData({...formData, name: e.target.value});
                                        if (errors.name) setErrors({...errors, name: null});
                                    }}
                                    error={errors.name}
                                />
                                <TextInput
                                    label="Adresse"
                                    type="text"
                                    placeholder="Strasse, PLZ Ort"
                                    value={formData.address}
                                    onChange={(e) => setFormData({...formData, address: e.target.value})}
                                />
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1.5">
                                            Nutzungstyp <span className="text-red-500">*</span>
                                        </label>
                                        <select
                                            value={formData.usageType}
                                            onChange={(e) => {
                                                setFormData({...formData, usageType: e.target.value});
                                                if (errors.usageType) setErrors({...errors, usageType: null});
                                            }}
                                            className={`w-full px-3 py-2 border rounded-lg text-sm transition-all duration-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none ${
                                                errors.usageType ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : 'border-slate-200'
                                            } ${!formData.usageType ? 'text-slate-400' : 'text-slate-900'}`}
                                        >
                                            {usageOptions.map(opt => (
                                                <option key={opt.value} value={opt.value} disabled={opt.value === ''}>
                                                    {opt.label}
                                                </option>
                                            ))}
                                        </select>
                                        {errors.usageType && <p className="mt-1 text-xs text-red-600">{errors.usageType}</p>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1.5">
                                            Framework <span className="text-red-500">*</span>
                                        </label>
                                        <select
                                            value={formData.framework}
                                            onChange={(e) => {
                                                setFormData({...formData, framework: e.target.value});
                                                if (errors.framework) setErrors({...errors, framework: null});
                                            }}
                                            className={`w-full px-3 py-2 border rounded-lg text-sm transition-all duration-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none ${
                                                errors.framework ? 'border-red-300 focus:ring-red-500 focus:border-red-500' : 'border-slate-200'
                                            } ${!formData.framework ? 'text-slate-400' : 'text-slate-900'}`}
                                        >
                                            {frameworkOptions.map(opt => (
                                                <option key={opt.value} value={opt.value} disabled={opt.value === ''}>
                                                    {opt.label}
                                                </option>
                                            ))}
                                        </select>
                                        {errors.framework && <p className="mt-1 text-xs text-red-600">{errors.framework}</p>}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1.5">
                                        Bauphase SIA 102
                                    </label>
                                    <select
                                        value={formData.phase}
                                        onChange={(e) => setFormData({...formData, phase: e.target.value})}
                                        className={`w-full px-3 py-2 border border-slate-200 rounded-lg text-sm transition-all duration-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none ${
                                            !formData.phase ? 'text-slate-400' : 'text-slate-900'
                                        }`}
                                    >
                                        {phaseOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>
                                                {opt.label}
                                            </option>
                                        ))}
                                    </select>
                                    <p className="mt-1 text-xs text-slate-500">Optional - kann später festgelegt werden</p>
                                </div>
                            </div>

                            {/* Modal Footer */}
                            <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                                <Button
                                    variant="ghost"
                                    onClick={handleClose}
                                    disabled={isSubmitting}
                                >
                                    Abbrechen
                                </Button>
                                <Button
                                    onClick={handleSubmit}
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? (
                                        <>
                                            <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                                            Wird erstellt...
                                        </>
                                    ) : (
                                        'Projekt erstellen'
                                    )}
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            };

            // ============ HEADER ============
            // Action button for header with tooltip
            const HeaderActionButton = ({ icon, label, onClick, badge }) => (
                <button
                    className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-emerald-500 relative"
                    onClick={onClick}
                    aria-label={label}
                    title={label}
                >
                    <MaterialIcon name={icon} size={20} />
                    {badge && (
                        <span className="absolute top-1 right-1 w-2 h-2 bg-emerald-500 rounded-full" />
                    )}
                </button>
            );

            const AppHeader = () => (
                <header className="bg-slate-900 text-white h-14 flex items-center justify-between px-4" role="banner">
                    <div className="flex items-center gap-3">
                        <button
                            className="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center cursor-pointer hover:bg-emerald-600 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 focus:ring-offset-slate-900"
                            onClick={() => setCurrentProject(null)}
                            aria-label="Zur Projektübersicht"
                            title="Zur Projektübersicht"
                        >
                            <MaterialIcon name="eco" size={18} />
                        </button>
                        <span className="font-semibold text-lg">Nachhaltigkeit</span>
                        {currentProject && (
                            <>
                                <span className="text-slate-600 select-none">/</span>
                                <span className="text-slate-300 font-medium">{currentProject.name}</span>
                            </>
                        )}
                    </div>

                    <div className="flex items-center gap-1">
                        <HeaderActionButton icon="help_outline" label="Hilfe" />
                        <HeaderActionButton icon="notifications" label="Benachrichtigungen" badge />
                        <HeaderActionButton icon="settings" label="Einstellungen" />
                        <div className="w-px h-6 bg-slate-700 mx-2" />
                        <button
                            className="flex items-center gap-2 p-1 rounded-lg hover:bg-slate-800 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            aria-label="Benutzerprofil"
                        >
                            <UserAvatar name="David Admin" size="md" className="bg-slate-700 text-slate-300" />
                        </button>
                    </div>
                </header>
            );

            // ============ SIDEBAR ============
            const MainSidebar = () => {
                const sidebarItems = [
                    { id: 'overview', label: 'Übersicht', icon: 'home', description: 'Projektübersicht' },
                    { id: 'evaluation', label: 'Bewertung', icon: 'rate_review', description: 'Varianten bewerten' },
                    { id: 'model3d', label: '3D Modell', icon: 'view_in_ar', requires3D: true, description: '3D Ansicht' },
                    { id: 'comparison', label: 'Vergleich', icon: 'compare', description: 'Varianten vergleichen' },
                ];

                const filteredItems = sidebarItems.filter(item => !item.requires3D || has3DModel);

                return (
                    <aside className="w-20 h-fit bg-white border border-slate-200 rounded-2xl flex flex-col shadow-sm" role="navigation" aria-label="Hauptnavigation">
                        <nav className="flex-1 py-4 flex flex-col gap-1">
                            {filteredItems.map(item => {
                                const isActive = sidebarView === item.id;
                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => setSidebarView(item.id)}
                                        title={item.description}
                                        className={`
                                            mx-2 px-2 py-3 flex flex-col items-center gap-1.5 rounded-xl
                                            transition-all duration-150
                                            focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 focus:ring-offset-white
                                            ${isActive
                                                ? 'bg-emerald-50 border-l-2 border-emerald-500'
                                                : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700 border-l-2 border-transparent'
                                            }
                                        `}
                                        aria-current={isActive ? 'page' : undefined}
                                        aria-label={item.description}
                                    >
                                        <div className={`
                                            w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-150
                                            ${isActive ? 'bg-emerald-100' : 'bg-slate-100'}
                                        `}>
                                            <MaterialIcon
                                                name={item.icon}
                                                size={22}
                                                className={isActive ? 'text-emerald-600' : 'text-slate-400'}
                                            />
                                        </div>
                                        <span className={`text-xs font-medium ${isActive ? 'text-emerald-700' : 'text-slate-500'}`}>
                                            {item.label}
                                        </span>
                                    </button>
                                );
                            })}
                        </nav>
                    </aside>
                );
            };

            // ============ VARIANT SELECTOR LIST ============
            const VariantSelectorList = () => {
                const isComparisonView = sidebarView === 'comparison';

                const handleVariantClick = (index) => {
                if (isComparisonView) {
                    if (selectedVariantsForCompare.includes(index)) {
                    if (selectedVariantsForCompare.length > 1) {
                        setSelectedVariantsForCompare(selectedVariantsForCompare.filter(i => i !== index));
                    }
                    } else {
                    setSelectedVariantsForCompare([...selectedVariantsForCompare, index].sort((a, b) => a - b));
                    }
                } else {
                    setSelectedVariant(index);
                }
                };

                return (
                <div className="w-60 h-fit bg-white rounded-xl border border-slate-200 flex-shrink-0 overflow-hidden">
                    <div className="px-4 py-3 border-b bg-slate-50">
                        <div className="flex items-center justify-between">
                            <div className="text-sm font-semibold text-slate-900">Varianten</div>
                            <span className="text-xs text-slate-500 bg-slate-200 px-2 py-0.5 rounded-full">{variants.length}</span>
                        </div>
                    </div>
                    <div className="max-h-[calc(100vh-280px)] overflow-y-auto">
                    {variants.map((v, i) => {
                        const isSelected = isComparisonView
                        ? selectedVariantsForCompare.includes(i)
                        : selectedVariant === i;

                        return (
                        <button
                            key={v.id}
                            onClick={() => handleVariantClick(i)}
                            className={`w-full p-3 text-left border-b last:border-b-0 transition-all duration-150 ${
                            isSelected
                                ? 'bg-emerald-50 border-l-4 border-l-emerald-500'
                                : 'hover:bg-slate-50 border-l-4 border-l-transparent'
                            }`}
                            aria-pressed={isSelected}
                        >
                            <div className="flex items-start gap-3">
                            <div className="flex-1 min-w-0">
                                {/* Thumbnail - increased height */}
                                <div className="w-full h-24 rounded-lg bg-slate-200 mb-2.5 overflow-hidden relative group">
                                <img
                                    src={v.thumbnail}
                                    alt={v.name}
                                    className="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
                                />
                                {isSelected && (
                                    <div className="absolute inset-0 border-2 border-emerald-500 rounded-lg ring-2 ring-emerald-500/30"></div>
                                )}
                                {/* Variant code badge */}
                                <div className="absolute top-2 right-2 bg-black/60 text-white text-xs px-1.5 py-0.5 rounded font-mono">
                                    {v.code}
                                </div>
                                </div>
                                <div className="font-medium text-sm text-slate-900 truncate">{v.name}</div>
                                <div className="text-xs text-slate-500 truncate">{v.firm}</div>
                            </div>
                            </div>
                        </button>
                        );
                    })}
                    </div>
                </div>
                );
            };

            // ============ COLLAPSIBLE SECTION COMPONENT ============
            const CollapsibleSection = ({ title, icon, badge, children, defaultOpen = true, actions }) => {
                const [isOpen, setIsOpen] = useState(defaultOpen);
                return (
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <button
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                    <MaterialIcon name={icon} size={18} className="text-slate-600" />
                                </div>
                                <span className="font-semibold text-slate-900">{title}</span>
                                {badge !== undefined && (
                                    <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                        {badge}
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                {actions && <div onClick={e => e.stopPropagation()}>{actions}</div>}
                                <MaterialIcon
                                    name={isOpen ? 'expand_less' : 'expand_more'}
                                    size={20}
                                    className="text-slate-400"
                                />
                            </div>
                        </button>
                        {isOpen && (
                            <div className="px-5 pb-5 border-t border-slate-100">
                                {children}
                            </div>
                        )}
                    </div>
                );
            };

            // ============ MAPBOX MAP SECTION ============
            const MAPBOX_TOKEN = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

            const MapSection = ({ address, coordinates, onAddressChange }) => {
                const mapContainerRef = useRef(null);
                const mapRef = useRef(null);
                const markerRef = useRef(null);
                const [isOpen, setIsOpen] = useState(true);
                const [isEditing, setIsEditing] = useState(false);
                const [editAddress, setEditAddress] = useState(address);
                const [isGeocoding, setIsGeocoding] = useState(false);

                useEffect(() => {
                    if (!mapContainerRef.current || mapRef.current) return;

                    mapboxgl.accessToken = MAPBOX_TOKEN;
                    mapRef.current = new mapboxgl.Map({
                        container: mapContainerRef.current,
                        style: 'mapbox://styles/mapbox/light-v11',
                        center: coordinates,
                        zoom: 15
                    });

                    mapRef.current.addControl(new mapboxgl.NavigationControl(), 'top-right');

                    markerRef.current = new mapboxgl.Marker({ color: '#10b981' })
                        .setLngLat(coordinates)
                        .addTo(mapRef.current);

                    return () => {
                        if (mapRef.current) {
                            mapRef.current.remove();
                            mapRef.current = null;
                        }
                    };
                }, []);

                useEffect(() => {
                    if (mapRef.current && markerRef.current) {
                        mapRef.current.flyTo({ center: coordinates, zoom: 15 });
                        markerRef.current.setLngLat(coordinates);
                    }
                }, [coordinates]);

                const handleGeocodeAddress = async () => {
                    if (!editAddress.trim()) return;
                    setIsGeocoding(true);
                    try {
                        const response = await fetch(
                            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(editAddress)}.json?access_token=${MAPBOX_TOKEN}&limit=1`
                        );
                        const data = await response.json();
                        if (data.features && data.features.length > 0) {
                            const [lng, lat] = data.features[0].center;
                            const placeName = data.features[0].place_name;
                            onAddressChange(placeName, [lng, lat]);
                            setEditAddress(placeName);
                            setIsEditing(false);
                        }
                    } catch (error) {
                        console.error('Geocoding error:', error);
                    }
                    setIsGeocoding(false);
                };

                return (
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <button
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                    <MaterialIcon name="map" size={18} className="text-blue-600" />
                                </div>
                                <span className="font-semibold text-slate-900">Standort</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div onClick={e => e.stopPropagation()}>
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        icon={isEditing ? "close" : "edit"}
                                        onClick={() => {
                                            setIsEditing(!isEditing);
                                            setEditAddress(address);
                                        }}
                                    >
                                        {isEditing ? 'Abbrechen' : 'Bearbeiten'}
                                    </Button>
                                </div>
                                <MaterialIcon
                                    name={isOpen ? 'expand_less' : 'expand_more'}
                                    size={20}
                                    className="text-slate-400"
                                />
                            </div>
                        </button>
                        {isOpen && (
                            <div className="px-5 pb-5 border-t border-slate-100">
                                <div className="pt-4">
                                    {isEditing ? (
                                        <div className="mb-4 flex gap-2">
                                            <input
                                                type="text"
                                                value={editAddress}
                                                onChange={(e) => setEditAddress(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleGeocodeAddress()}
                                                placeholder="Adresse eingeben..."
                                                className="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                                            />
                                            <Button
                                                variant="primary"
                                                size="sm"
                                                icon="search"
                                                onClick={handleGeocodeAddress}
                                                disabled={isGeocoding}
                                            >
                                                {isGeocoding ? 'Suche...' : 'Suchen'}
                                            </Button>
                                        </div>
                                    ) : (
                                        <div className="mb-4 flex items-center gap-2 text-sm text-slate-600">
                                            <MaterialIcon name="location_on" size={16} className="text-slate-400" />
                                            {address}
                                        </div>
                                    )}
                                    <div
                                        ref={mapContainerRef}
                                        className="w-full h-64 rounded-lg"
                                    />
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ============ IMAGE GALLERY SECTION ============
            const ImageGallerySection = ({ images, onImagesChange }) => {
                const [isOpen, setIsOpen] = useState(true);
                const [isEditing, setIsEditing] = useState(false);
                const fileInputRef = useRef(null);

                const handleFileSelect = (e) => {
                    const files = Array.from(e.target.files);
                    const newImages = files.map(file => ({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        url: URL.createObjectURL(file),
                        file: file
                    }));
                    onImagesChange([...images, ...newImages]);
                    e.target.value = '';
                };

                const handleDeleteImage = (imageId) => {
                    onImagesChange(images.filter(img => img.id !== imageId));
                };

                return (
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <button
                            onClick={() => setIsOpen(!isOpen)}
                            className="w-full px-5 py-4 flex items-center justify-between hover:bg-slate-50 transition-colors"
                        >
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center">
                                    <MaterialIcon name="photo_library" size={18} className="text-violet-600" />
                                </div>
                                <span className="font-semibold text-slate-900">Bilder</span>
                                {images.length > 0 && (
                                    <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                        {images.length}
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                <div onClick={e => e.stopPropagation()}>
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        icon={isEditing ? "close" : "edit"}
                                        onClick={() => setIsEditing(!isEditing)}
                                    >
                                        {isEditing ? 'Fertig' : 'Bearbeiten'}
                                    </Button>
                                </div>
                                <MaterialIcon
                                    name={isOpen ? 'expand_less' : 'expand_more'}
                                    size={20}
                                    className="text-slate-400"
                                />
                            </div>
                        </button>
                        {isOpen && (
                            <div className="px-5 pb-5 border-t border-slate-100">
                                <div className="pt-4">
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        onChange={handleFileSelect}
                                        accept="image/*"
                                        multiple
                                        className="hidden"
                                    />

                                    {images.length === 0 ? (
                                        <div
                                            onClick={() => fileInputRef.current?.click()}
                                            className="border-2 border-dashed border-slate-200 rounded-lg p-8 text-center cursor-pointer hover:border-emerald-300 hover:bg-emerald-50/50 transition-colors"
                                        >
                                            <MaterialIcon name="add_photo_alternate" size={32} className="text-slate-400 mx-auto mb-2" />
                                            <p className="text-sm text-slate-600">Klicken zum Hochladen</p>
                                            <p className="text-xs text-slate-400 mt-1">oder Dateien hierher ziehen</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-4 gap-3 mb-4">
                                                {images.map((image) => (
                                                    <div key={image.id} className="relative group aspect-square">
                                                        <img
                                                            src={image.url}
                                                            alt={image.name}
                                                            className="w-full h-full object-cover rounded-lg"
                                                        />
                                                        {isEditing && (
                                                            <button
                                                                onClick={() => handleDeleteImage(image.id)}
                                                                className="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                                                            >
                                                                <MaterialIcon name="close" size={14} />
                                                            </button>
                                                        )}
                                                        {!isEditing && (
                                                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors rounded-lg" />
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                            <Button
                                                variant="secondary"
                                                size="sm"
                                                icon="add"
                                                onClick={() => fileInputRef.current?.click()}
                                            >
                                                Weitere Bilder hinzufügen
                                            </Button>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ============ PROJECT OVERVIEW VIEW ============
            const ProjectOverviewView = () => {
                const teamMembers = [
                    { name: 'David Rasner', email: 'david.rasner@example.ch', role: 'Projektleiter' },
                    { name: 'Matthias Spiss', email: 'matthias.spiss@allreal.ch', role: 'Admin' },
                    { name: 'Adrian Schmid', email: 'adrian.schmid@allreal.ch', role: 'Admin' },
                ];

                const experts = [
                    { name: 'Dr. Eva Müller', role: 'Tageslicht, Raumklima' },
                    { name: 'Thomas Weber', role: 'Lebenszykluskosten' },
                    { name: 'Sarah Koch', role: 'Energie' },
                ];

                const milestones = [
                    { date: '15.07.2024', label: 'Abgabe BIM Modelle (90%)', done: true },
                    { date: '21.07.2024', label: 'Abgabe definitive BIM Modelle', done: true },
                    { date: '15.08.2024', label: 'Bewertung Funktionalität', done: true },
                    { date: '30.08.2024', label: 'Bewertung Komfort & Wirtschaftlichkeit', done: false },
                    { date: '15.09.2024', label: 'Abgabe Kosten Kalkulation', done: false },
                    { date: '30.09.2024', label: 'Jurysitzung', done: false },
                ];

                const pendingMilestones = milestones.filter(m => !m.done).length;

                // Map state - Badenerstrasse 501, Zürich coordinates
                const [mapAddress, setMapAddress] = useState(currentProject?.address || 'Badenerstrasse 501, 8048 Zürich, Switzerland');
                const [mapCoordinates, setMapCoordinates] = useState([8.4878, 47.3867]); // Lng, Lat for Zürich

                const handleMapAddressChange = (newAddress, newCoordinates) => {
                    setMapAddress(newAddress);
                    setMapCoordinates(newCoordinates);
                };

                // Image gallery state
                const [projectImages, setProjectImages] = useState([]);

                // Team member row component
                const TeamMemberRow = ({ member, isExpert = false }) => (
                    <div className="py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <UserAvatar
                                name={member.name}
                                size="md"
                                className={isExpert ? 'bg-emerald-100 text-emerald-700' : ''}
                            />
                            <div>
                                <div className="text-sm font-medium text-slate-900">{member.name}</div>
                                <div className="text-xs text-slate-500">{member.email || member.role}</div>
                            </div>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded ${
                            isExpert ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'
                        }`}>
                            {isExpert ? 'Experte' : member.role}
                        </span>
                    </div>
                );

                return (
                    <div className="flex-1 space-y-4">
                        {/* Project Header Card */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6">
                            <div className="flex items-start justify-between mb-6">
                                <div>
                                    <h2 className="text-xl font-semibold text-slate-900">{currentProject?.name || 'Badenerstrasse 501'}</h2>
                                    <p className="text-sm text-slate-500 mt-1">{currentProject?.address || 'Badenerstrasse 501, 8048 Zürich'}</p>
                                </div>
                                <StatusBadge status="active" label="Bewertung läuft" />
                            </div>

                            {/* Stats Grid */}
                            <div className="grid grid-cols-4 gap-4 mb-6">
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <MaterialIcon name="apartment" size={20} className="text-blue-600" />
                                        </div>
                                        <div>
                                            <div className="text-2xl font-bold text-slate-900">5</div>
                                            <div className="text-xs text-slate-500">Varianten</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                            <MaterialIcon name="check_circle" size={20} className="text-emerald-600" />
                                        </div>
                                        <div>
                                            <div className="text-2xl font-bold text-emerald-600">2</div>
                                            <div className="text-xs text-slate-500">Bewertet</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                                            <MaterialIcon name="pending" size={20} className="text-amber-600" />
                                        </div>
                                        <div>
                                            <div className="text-2xl font-bold text-amber-600">3</div>
                                            <div className="text-xs text-slate-500">In Arbeit</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-violet-100 rounded-lg flex items-center justify-center">
                                            <MaterialIcon name="groups" size={20} className="text-violet-600" />
                                        </div>
                                        <div>
                                            <div className="text-2xl font-bold text-slate-900">6</div>
                                            <div className="text-xs text-slate-500">Teammitglieder</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Project Details */}
                            <div className="border-t border-slate-100 pt-5">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-sm font-semibold text-slate-700 uppercase tracking-wide">Projektdetails</h3>
                                    <button
                                        className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        aria-label="Projektdetails bearbeiten"
                                    >
                                        <MaterialIcon name="edit" size={16} />
                                    </button>
                                </div>
                                <div className="grid grid-cols-3 gap-6">
                                    <LabelValuePair label="Nutzungstyp">Wohnen</LabelValuePair>
                                    <LabelValuePair label="Bauphase SIA 102">Vorprojekt</LabelValuePair>
                                    <LabelValuePair label="Framework">
                                        <span className="flex items-center gap-2">
                                            SNAP
                                            <StatusBadge status="success" label="15 Kriterien" showDot={false} size="sm" />
                                        </span>
                                    </LabelValuePair>
                                </div>
                            </div>
                        </div>

                        {/* Evaluation Progress Section */}
                        <div className="bg-white rounded-xl border border-slate-200 p-6">
                            <div className="flex items-center gap-3 mb-5">
                                <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <MaterialIcon name="assessment" size={18} className="text-emerald-600" />
                                </div>
                                <h3 className="font-semibold text-slate-900">Bewertungsfortschritt</h3>
                            </div>
                            <div className="grid grid-cols-2 gap-x-8 gap-y-4">
                                {Object.values(themes).map(theme => {
                                    const progress = theme.id === 'functionality' ? 100 :
                                        theme.id === 'comfort' ? 75 :
                                        theme.id === 'economics' ? 40 : 20;
                                    const themeColors = {
                                        functionality: 'blue',
                                        comfort: 'emerald',
                                        economics: 'amber',
                                        resources: 'violet'
                                    };
                                    const color = themeColors[theme.id];
                                    return (
                                        <div key={theme.id} className="flex items-center gap-4">
                                            <div className={`w-2 h-2 rounded-full bg-${color}-500`}></div>
                                            <div className="flex-1">
                                                <div className="flex justify-between text-sm mb-1.5">
                                                    <span className="font-medium text-slate-700">{theme.name}</span>
                                                    <span className={progress === 100 ? 'text-emerald-600 font-medium' : 'text-slate-500'}>{progress}%</span>
                                                </div>
                                                <ProgressBar
                                                    value={progress}
                                                    color={progress === 100 ? 'emerald' : 'amber'}
                                                />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Quick Actions - Position 3 */}
                        <div className="bg-white rounded-xl border border-slate-200 p-5">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                                        <MaterialIcon name="bolt" size={18} className="text-slate-600" />
                                    </div>
                                    <span className="font-semibold text-slate-900">Schnellaktionen</span>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    <Button variant="secondary" size="sm" icon="download">Bericht exportieren</Button>
                                    <Button variant="secondary" size="sm" icon="share">Projekt teilen</Button>
                                    <Button variant="secondary" size="sm" icon="archive">Archivieren</Button>
                                </div>
                            </div>
                        </div>

                        {/* Map Section */}
                        <MapSection
                            address={mapAddress}
                            coordinates={mapCoordinates}
                            onAddressChange={handleMapAddressChange}
                        />

                        {/* Image Gallery Section */}
                        <ImageGallerySection
                            images={projectImages}
                            onImagesChange={setProjectImages}
                        />

                        {/* Team Section - Collapsible */}
                        <CollapsibleSection
                            title="Team"
                            icon="groups"
                            badge={teamMembers.length + experts.length}
                            actions={<Button variant="ghost" size="sm" icon="person_add">Einladen</Button>}
                        >
                            <div className="pt-4">
                                <div className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Projektteam</div>
                                <div className="divide-y divide-slate-100">
                                    {teamMembers.map((m, i) => (
                                        <TeamMemberRow key={i} member={m} />
                                    ))}
                                </div>

                                <div className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3 mt-6">Experten</div>
                                <div className="divide-y divide-slate-100">
                                    {experts.map((m, i) => (
                                        <TeamMemberRow key={i} member={m} isExpert />
                                    ))}
                                </div>
                            </div>
                        </CollapsibleSection>

                        {/* Timeline Section - Collapsible */}
                        <CollapsibleSection
                            title="Zeitplan"
                            icon="schedule"
                            badge={pendingMilestones > 0 ? `${pendingMilestones} offen` : undefined}
                            actions={<Button variant="ghost" size="sm" icon="add">Hinzufügen</Button>}
                        >
                            <div className="pt-4 space-y-3">
                                {milestones.map((m, i) => (
                                    <div key={i} className={`flex items-center gap-4 p-3 rounded-lg transition-colors ${m.done ? 'bg-slate-50' : 'bg-amber-50 border border-amber-100'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                                            m.done ? 'bg-emerald-100' : 'bg-amber-100'
                                        }`}>
                                            <MaterialIcon
                                                name={m.done ? 'check' : 'schedule'}
                                                size={16}
                                                className={m.done ? 'text-emerald-600' : 'text-amber-600'}
                                            />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className={`text-sm font-medium ${m.done ? 'text-slate-500 line-through' : 'text-slate-900'}`}>
                                                {m.label}
                                            </div>
                                            <div className="text-xs text-slate-500">{m.date}</div>
                                        </div>
                                        {!m.done && (
                                            <button className="text-xs text-emerald-600 hover:text-emerald-700 font-medium whitespace-nowrap">
                                                Erledigt
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </CollapsibleSection>
                    </div>
                );
            };


            // ============ BREADCRUMB ============
            const NavigationBreadcrumb = () => {
                // Don't show breadcrumb in gallery view
                if (!currentProject) return null;

                // Map sidebar views to human-readable labels
                const viewLabels = {
                    overview: 'Übersicht',
                    evaluation: 'Bewertung',
                    model3d: '3D Modell',
                    comparison: 'Vergleich'
                };

                const getBreadcrumbItems = () => {
                    const items = [
                        { label: 'Projekte', icon: 'folder', active: false, onClick: () => setCurrentProject(null) },
                        { label: currentProject.name, active: sidebarView === 'overview', onClick: () => setSidebarView('overview') }
                    ];

                    if (sidebarView === 'evaluation') {
                        items[1].active = false;
                        items.push({ label: currentVariant.name, active: false, isVariantSelector: true });
                        items.push({ label: viewLabels.evaluation, active: true });
                    } else if (sidebarView === 'model3d') {
                        items[1].active = false;
                        items.push({ label: currentVariant.name, active: false, isVariantSelector: true });
                        items.push({ label: viewLabels.model3d, active: true });
                    } else if (sidebarView === 'comparison') {
                        items[1].active = false;
                        items.push({ label: viewLabels.comparison, active: true });
                    }

                    return items;
                };

                const items = getBreadcrumbItems();

                // Variant dropdown selector component
                const VariantDropdownSelector = ({ currentName }) => {
                    const [isOpen, setIsOpen] = React.useState(false);
                    return (
                        <div className="relative">
                            <button
                                onClick={() => setIsOpen(!isOpen)}
                                className="px-2 py-1 rounded-md text-slate-900 font-medium bg-slate-100 hover:bg-slate-200 transition-colors flex items-center gap-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                aria-haspopup="listbox"
                                aria-expanded={isOpen}
                            >
                                {currentName}
                                <MaterialIcon name="expand_more" size={16} className="text-slate-500" />
                            </button>
                            {isOpen && (
                                <>
                                    <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)} />
                                    <div className="absolute top-full left-0 mt-1 w-56 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-20">
                                        {variants.map((v, i) => (
                                            <button
                                                key={v.id}
                                                onClick={() => {
                                                    setSelectedVariant(i);
                                                    setIsOpen(false);
                                                }}
                                                className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2 ${
                                                    selectedVariant === i ? 'bg-emerald-50 text-emerald-700' : 'text-slate-700'
                                                }`}
                                            >
                                                <div className="w-8 h-8 rounded bg-slate-200 overflow-hidden flex-shrink-0">
                                                    <img src={v.thumbnail} alt="" className="w-full h-full object-cover" />
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium truncate">{v.name}</div>
                                                    <div className="text-xs text-slate-500">{v.code}</div>
                                                </div>
                                                {selectedVariant === i && (
                                                    <MaterialIcon name="check" size={16} className="text-emerald-600" />
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    );
                };

                return (
                    <nav
                        className="h-11 bg-white border-b border-slate-200"
                        aria-label="Breadcrumb"
                    >
                        <div className="max-w-[1400px] mx-auto h-full px-6 flex items-center">
                        <ol className="flex items-center gap-1 text-sm">
                            {items.map((item, index) => (
                                <li key={index} className="flex items-center">
                                    {index > 0 && (
                                        <MaterialIcon name="chevron_right" size={16} className="text-slate-300 mx-1" />
                                    )}
                                    {item.isVariantSelector ? (
                                        <VariantDropdownSelector currentName={item.label} />
                                    ) : item.onClick ? (
                                        <button
                                            onClick={item.onClick}
                                            className={`
                                                px-2 py-1 rounded-md transition-colors duration-150
                                                focus:outline-none focus:ring-2 focus:ring-emerald-500
                                                ${item.active
                                                    ? 'text-slate-900 font-medium bg-slate-100'
                                                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'
                                                }
                                            `}
                                            aria-current={item.active ? 'page' : undefined}
                                        >
                                            <span className="flex items-center gap-1.5">
                                                {item.icon && <MaterialIcon name={item.icon} size={14} />}
                                                {item.label}
                                            </span>
                                        </button>
                                    ) : (
                                        <span
                                            className={`px-2 py-1 ${item.active ? 'text-slate-900 font-medium' : 'text-slate-500'}`}
                                            aria-current={item.active ? 'page' : undefined}
                                        >
                                            {item.label}
                                        </span>
                                    )}
                                </li>
                            ))}
                        </ol>
                        </div>
                    </nav>
                );
            };

            // ============ VARIANT HEADER CARD (Simplified from AllgemeinSection) ============
            const VariantHeaderCard = () => {
                const variant = variants[selectedVariant];

                // Asset counts for quick access badges
                const assetCounts = {
                    images: variant.images?.length || 2,
                    documents: 2,
                    models: 1
                };

                return (
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div className="flex">
                            {/* Left: Variant Image */}
                            <div className="w-64 h-44 relative flex-shrink-0">
                                <img
                                    src={variant.thumbnail}
                                    alt={variant.name}
                                    className="w-full h-full object-cover"
                                />
                                <div className="absolute inset-0 bg-gradient-to-r from-black/60 via-black/30 to-transparent"></div>
                                <div className="absolute bottom-4 left-4 text-white">
                                    <div className="text-lg font-semibold">{variant.name}</div>
                                    <div className="text-white/80 text-sm">{variant.firm}</div>
                                </div>
                                <div className="absolute top-3 left-3">
                                    <span className="px-2 py-1 bg-black/40 backdrop-blur rounded text-white text-xs font-mono">
                                        {variant.code}
                                    </span>
                                </div>
                            </div>

                            {/* Right: Details */}
                            <div className="flex-1 p-5">
                                {/* Key Metrics Row */}
                                <div className="flex items-center gap-6 mb-4 pb-4 border-b border-slate-100">
                                    <div>
                                        <div className="text-xl font-bold text-slate-900">7'816</div>
                                        <div className="text-xs text-slate-500">GF (m²)</div>
                                    </div>
                                    <div>
                                        <div className="text-xl font-bold text-slate-900">23'332</div>
                                        <div className="text-xs text-slate-500">GV (m³)</div>
                                    </div>
                                    <div>
                                        <div className="text-xl font-bold text-slate-900">0.64</div>
                                        <div className="text-xs text-slate-500">NF/BGF</div>
                                    </div>
                                    <div>
                                        <div className="text-xl font-bold text-slate-900">14</div>
                                        <div className="text-xs text-slate-500">Geschosse</div>
                                    </div>
                                    <div className="ml-auto flex items-center gap-2">
                                        <button
                                            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                            title="Daten exportieren"
                                        >
                                            <MaterialIcon name="download" size={18} />
                                        </button>
                                        <button
                                            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                            title="Drucken"
                                        >
                                            <MaterialIcon name="print" size={18} />
                                        </button>
                                    </div>
                                </div>

                                {/* Quick Info & Assets */}
                                <div className="flex items-center justify-between">
                                    {/* Submission Info */}
                                    <div className="flex items-center gap-6 text-sm">
                                        <div>
                                            <span className="text-slate-500">Eingereicht:</span>
                                            <span className="ml-1.5 text-slate-700 font-medium">25.03.2023</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <MaterialIcon name="check_circle" size={16} className="text-emerald-500" />
                                            <span className="text-slate-700">BIM Modell vorhanden</span>
                                        </div>
                                    </div>

                                    {/* Asset Quick Links */}
                                    <div className="flex items-center gap-2">
                                        <button className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                            <MaterialIcon name="image" size={16} className="text-slate-400" />
                                            <span>{assetCounts.images} Bilder</span>
                                        </button>
                                        <button className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                            <MaterialIcon name="description" size={16} className="text-slate-400" />
                                            <span>{assetCounts.documents} Dokumente</span>
                                        </button>
                                        <button className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                                            <MaterialIcon name="view_in_ar" size={16} className="text-slate-400" />
                                            <span>{assetCounts.models} 3D</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // ============ SNAP KRITERIEN SECTION ============
            const SNAPKriterienSection = () => {
                // Track which themes are expanded
                const [expandedThemes, setExpandedThemes] = useState(['functionality']);

                const toggleTheme = (themeId) => {
                    setExpandedThemes(prev =>
                        prev.includes(themeId)
                            ? prev.filter(id => id !== themeId)
                            : [...prev, themeId]
                    );
                };

                // Theme styling configuration
                const themeConfig = {
                    functionality: { icon: 'settings_accessibility', color: 'blue', progress: 100 },
                    comfort: { icon: 'spa', color: 'emerald', progress: 75 },
                    economics: { icon: 'payments', color: 'amber', progress: 40 },
                    resources: { icon: 'bolt', color: 'violet', progress: 20 }
                };

                const colorClasses = {
                    blue: { bg: 'bg-blue-500', bgLight: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-200' },
                    emerald: { bg: 'bg-emerald-500', bgLight: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-200' },
                    amber: { bg: 'bg-amber-500', bgLight: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-200' },
                    violet: { bg: 'bg-violet-500', bgLight: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-200' }
                };

                // Theme Card Component
                const ThemeCard = ({ theme }) => {
                    const config = themeConfig[theme.id];
                    const colors = colorClasses[config.color];
                    const isExpanded = expandedThemes.includes(theme.id);
                    const themeKennwerte = generateKennwertData(selectedVariant, theme.kennwerte);
                    const themeKriterien = generateKriterienData(selectedVariant, theme.kriterien);

                    // Count ratings for summary
                    const ratingCounts = themeKriterien.reduce((acc, k) => {
                        acc[k.rating] = (acc[k.rating] || 0) + 1;
                        return acc;
                    }, {});

                    return (
                        <div className={`bg-white rounded-xl border overflow-hidden transition-all ${isExpanded ? colors.border : 'border-slate-200'}`}>
                            {/* Theme Header - Always visible */}
                            <button
                                onClick={() => toggleTheme(theme.id)}
                                className={`w-full px-5 py-4 flex items-center gap-4 hover:bg-slate-50 transition-colors ${isExpanded ? colors.bgLight : ''}`}
                            >
                                {/* Color indicator */}
                                <div className={`w-1 h-12 rounded-full ${colors.bg}`}></div>

                                {/* Icon */}
                                <div className={`w-10 h-10 rounded-lg ${colors.bgLight} flex items-center justify-center`}>
                                    <MaterialIcon name={config.icon} size={22} className={colors.text} />
                                </div>

                                {/* Title & Progress */}
                                <div className="flex-1 text-left">
                                    <div className="font-semibold text-slate-900">{theme.name}</div>
                                    <div className="text-sm text-slate-500">
                                        {theme.kriterien.length} Kriterien · {theme.kennwerte.length} Kennwerte
                                    </div>
                                </div>

                                {/* Rating Summary Badges */}
                                <div className="flex items-center gap-2 mr-4">
                                    {ratingCounts.positive > 0 && (
                                        <span className="flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-medium">
                                            <span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                            {ratingCounts.positive}
                                        </span>
                                    )}
                                    {ratingCounts.neutral > 0 && (
                                        <span className="flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-medium">
                                            <span className="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                            {ratingCounts.neutral}
                                        </span>
                                    )}
                                    {ratingCounts.negative > 0 && (
                                        <span className="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
                                            <span className="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                                            {ratingCounts.negative}
                                        </span>
                                    )}
                                </div>

                                {/* Progress indicator */}
                                <div className="flex items-center gap-3 w-32">
                                    <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div
                                            className={`h-full rounded-full ${config.progress === 100 ? 'bg-emerald-500' : colors.bg}`}
                                            style={{ width: `${config.progress}%` }}
                                        ></div>
                                    </div>
                                    <span className="text-sm text-slate-500 w-10">{config.progress}%</span>
                                </div>

                                {/* Expand/Collapse icon */}
                                <MaterialIcon
                                    name={isExpanded ? 'expand_less' : 'expand_more'}
                                    size={20}
                                    className="text-slate-400"
                                />
                            </button>

                            {/* Expanded Content */}
                            {isExpanded && (
                                <div className="border-t border-slate-100">
                                    {/* Kennwerte Section */}
                                    <div className="px-5 py-4 border-b border-slate-100">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="text-sm font-semibold text-slate-700">Kennwerte</h4>
                                            <span className="text-xs text-slate-400">Teilnehmer {currentVariant.code}</span>
                                        </div>
                                        <div className="space-y-3">
                                            {themeKennwerte.map(k => (
                                                <div key={k.id} className="flex items-center gap-4">
                                                    <div className="w-48 text-sm text-slate-600 truncate">
                                                        {k.label} {k.unit && <span className="text-slate-400">({k.unit})</span>}
                                                    </div>
                                                    <div className="w-16 text-sm font-medium text-slate-900">
                                                        {k.value}{k.unit === '%' ? '%' : ''}
                                                    </div>
                                                    <div className="flex-1 h-5 bg-slate-100 rounded relative">
                                                        <div
                                                            className={`absolute top-0 left-0 h-full rounded ${k.delta >= 0 ? 'bg-emerald-400' : 'bg-red-400'}`}
                                                            style={{ width: `${Math.min(k.value, 100)}%` }}
                                                        />
                                                        <div
                                                            className="absolute top-0 h-full w-0.5 bg-slate-600"
                                                            style={{ left: `${k.avg}%` }}
                                                        />
                                                    </div>
                                                    <div className={`w-14 text-right text-sm font-medium ${k.delta >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                        {k.delta >= 0 ? '+' : ''}{k.delta}%
                                                    </div>
                                                    <div className="w-12 text-right text-xs text-slate-400">
                                                        {k.rank}/{k.total}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Kriterien Section */}
                                    <div className="px-5 py-4">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="text-sm font-semibold text-slate-700">Kriterien</h4>
                                            <button
                                                onClick={(e) => { e.stopPropagation(); setIsEditMode(!isEditMode); }}
                                                className={`flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-lg transition-colors ${
                                                    isEditMode
                                                        ? 'bg-emerald-600 text-white hover:bg-emerald-700'
                                                        : 'text-slate-500 hover:bg-slate-100'
                                                }`}
                                            >
                                                <MaterialIcon name={isEditMode ? 'check' : 'edit'} size={14} />
                                                {isEditMode ? 'Speichern' : 'Bearbeiten'}
                                            </button>
                                        </div>
                                        <div className="space-y-2">
                                            {themeKriterien.map(k => (
                                                <div key={k.id} className={`flex items-start gap-4 p-3 rounded-lg transition-colors ${isEditMode ? 'bg-slate-50' : 'hover:bg-slate-50'}`}>
                                                    {/* Traffic Light Rating Selector */}
                                                    {isEditMode ? (
                                                        <div className="flex gap-1 flex-shrink-0" onClick={e => e.stopPropagation()}>
                                                            {/* Negative button */}
                                                            <button
                                                                onClick={() => updateCriterionRating(selectedVariant, k.id, 'negative')}
                                                                className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${
                                                                    k.rating === 'negative'
                                                                        ? 'bg-red-500 text-white ring-2 ring-red-300 ring-offset-1'
                                                                        : 'bg-red-100 text-red-400 hover:bg-red-200 hover:text-red-500'
                                                                }`}
                                                                title="Negativ (−)"
                                                            >
                                                                <span className="text-sm font-bold">−</span>
                                                            </button>
                                                            {/* Neutral button */}
                                                            <button
                                                                onClick={() => updateCriterionRating(selectedVariant, k.id, 'neutral')}
                                                                className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${
                                                                    k.rating === 'neutral'
                                                                        ? 'bg-amber-500 text-white ring-2 ring-amber-300 ring-offset-1'
                                                                        : 'bg-amber-100 text-amber-400 hover:bg-amber-200 hover:text-amber-500'
                                                                }`}
                                                                title="Neutral (○)"
                                                            >
                                                                <span className="text-sm font-bold">○</span>
                                                            </button>
                                                            {/* Positive button */}
                                                            <button
                                                                onClick={() => updateCriterionRating(selectedVariant, k.id, 'positive')}
                                                                className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${
                                                                    k.rating === 'positive'
                                                                        ? 'bg-emerald-500 text-white ring-2 ring-emerald-300 ring-offset-1'
                                                                        : 'bg-emerald-100 text-emerald-400 hover:bg-emerald-200 hover:text-emerald-500'
                                                                }`}
                                                                title="Positiv (+)"
                                                            >
                                                                <span className="text-sm font-bold">+</span>
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        /* Read-only rating indicator */
                                                        <div className={`w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0 ${
                                                            k.rating === 'positive' ? 'bg-emerald-100' :
                                                            k.rating === 'neutral' ? 'bg-amber-100' : 'bg-red-100'
                                                        }`}>
                                                            <span className={`text-sm font-bold ${
                                                                k.rating === 'positive' ? 'text-emerald-600' :
                                                                k.rating === 'neutral' ? 'text-amber-600' : 'text-red-600'
                                                            }`}>
                                                                {k.rating === 'positive' ? '+' : k.rating === 'neutral' ? '○' : '−'}
                                                            </span>
                                                        </div>
                                                    )}

                                                    {/* Criterion details */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-xs text-slate-400 font-mono">{k.id}</span>
                                                            <span className="text-sm font-medium text-slate-900">{k.name}</span>
                                                        </div>
                                                        {isEditMode ? (
                                                            <textarea
                                                                className="w-full text-sm text-slate-600 bg-white border border-slate-200 rounded-lg p-2.5 min-h-20 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                                                defaultValue={k.comment}
                                                                placeholder="Anmerkungen eingeben..."
                                                                onClick={e => e.stopPropagation()}
                                                                onBlur={e => updateCriterionComment(selectedVariant, k.id, e.target.value)}
                                                            />
                                                        ) : (
                                                            <div className="text-sm text-slate-500 leading-relaxed">{k.comment}</div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                };

                return (
                    <div className="space-y-3">
                        {/* Section Title */}
                        <div className="flex items-center justify-between px-1">
                            <h2 className="text-lg font-semibold text-slate-900">SNAP Bewertung</h2>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setExpandedThemes(Object.keys(themes))}
                                    className="text-xs text-slate-500 hover:text-slate-700 px-2 py-1 hover:bg-slate-100 rounded"
                                >
                                    Alle öffnen
                                </button>
                                <button
                                    onClick={() => setExpandedThemes([])}
                                    className="text-xs text-slate-500 hover:text-slate-700 px-2 py-1 hover:bg-slate-100 rounded"
                                >
                                    Alle schließen
                                </button>
                            </div>
                        </div>

                        {/* Theme Cards */}
                        {Object.values(themes).map(theme => (
                            <ThemeCard key={theme.id} theme={theme} />
                        ))}
                    </div>
                );
            };

            // ============ 3D MODEL VIEWER ============
            const Model3DViewer = () => (
                <div className="flex-1 bg-white rounded-xl border border-slate-200 flex flex-col min-h-[600px]">
                    {/* Toolbar */}
                    <div className="bg-slate-50 border-b px-4 py-2 flex items-center justify-between">
                        <div className="flex items-center gap-1">
                            <button className="px-3 py-1.5 text-sm bg-white border rounded hover:bg-slate-50 flex items-center gap-1.5">
                                <MaterialIcon name="restart_alt" size={16} /> Reset
                            </button>
                            <button className="px-3 py-1.5 text-sm bg-white border rounded hover:bg-slate-50 flex items-center gap-1.5">
                                <MaterialIcon name="carpenter" size={16} /> Schnitt
                            </button>
                            <button className="px-3 py-1.5 text-sm bg-white border rounded hover:bg-slate-50 flex items-center gap-1.5">
                                <MaterialIcon name="straighten" size={16} /> Messen
                            </button>
                            <div className="w-px h-6 bg-slate-200 mx-2" />
                            <button className="px-3 py-1.5 text-sm bg-white border rounded hover:bg-slate-50 flex items-center gap-1.5">
                                <MaterialIcon name="layers" size={16} /> Geschosse
                            </button>
                            <button className="px-3 py-1.5 text-sm bg-white border rounded hover:bg-slate-50 flex items-center gap-1.5">
                                <MaterialIcon name="visibility" size={16} /> Sichtbarkeit
                            </button>
                        </div>
                        <div className="flex items-center gap-2 text-sm text-slate-500">
                            <MaterialIcon name="description" size={16} />
                            <span>IFC Model</span>
                            <span className="text-slate-300">|</span>
                            <span>Hochgeladen: 25.03.2023</span>
                        </div>
                    </div>

                    {/* 3D Canvas */}
                    <div className="flex-1 bg-slate-900 relative">
                            {/* Fake 3D building visualization */}
                            <div className="absolute inset-0 flex items-center justify-center">
                                <div className="relative" style={{ perspective: '1000px' }}>
                                    <div
                                        className="w-64 h-80 relative"
                                        style={{
                                            transformStyle: 'preserve-3d',
                                            transform: 'rotateX(-15deg) rotateY(-25deg)'
                                        }}
                                    >
                                        {/* Building floors */}
                                        {[...Array(12)].map((_, i) => (
                                            <div
                                                key={i}
                                                className="absolute w-full bg-gradient-to-r from-slate-600 to-slate-700 border border-slate-500"
                                                style={{
                                                    height: '20px',
                                                    bottom: `${i * 22}px`,
                                                    transform: `translateZ(${20}px)`,
                                                    boxShadow: '4px 4px 0 rgba(0,0,0,0.3)'
                                                }}
                                            >
                                                {/* Windows */}
                                                <div className="absolute inset-1 flex gap-1">
                                                    {[...Array(8)].map((_, j) => (
                                                        <div
                                                            key={j}
                                                            className="flex-1 bg-amber-200 opacity-60"
                                                            style={{ opacity: Math.random() > 0.3 ? 0.7 : 0.2 }}
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Viewer info overlay */}
                            <div className="absolute bottom-4 left-4 bg-black/50 text-white px-3 py-2 rounded text-sm">
                                <div className="font-medium">{currentVariant.name}</div>
                                <div className="text-slate-300 text-xs">{currentVariant.firm}</div>
                            </div>

                            {/* Controls hint */}
                            <div className="absolute bottom-4 right-4 bg-black/50 text-white px-3 py-2 rounded text-xs space-y-1">
                                <div className="flex items-center gap-2"><MaterialIcon name="mouse" size={14} /> Drehen: Linksklick + Ziehen</div>
                                <div className="flex items-center gap-2"><MaterialIcon name="zoom_in" size={14} /> Zoom: Scrollrad</div>
                                <div className="flex items-center gap-2"><MaterialIcon name="pan_tool" size={14} /> Verschieben: Rechtsklick</div>
                            </div>

                            {/* Model stats */}
                            <div className="absolute top-4 right-4 bg-black/50 text-white px-4 py-3 rounded">
                                <div className="text-xs text-slate-400 uppercase tracking-wide mb-2">Modell-Daten</div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                    <span className="text-slate-400">GF Total:</span>
                                    <span className="font-medium">7'816 m²</span>
                                    <span className="text-slate-400">GV Total:</span>
                                    <span className="font-medium">23'332 m³</span>
                                    <span className="text-slate-400">Geschosse:</span>
                                    <span className="font-medium">14</span>
                                    <span className="text-slate-400">Elemente:</span>
                                    <span className="font-medium">12'847</span>
                                </div>
                            </div>
                        </div>
                </div>
            );

            // ============ VARIANT COMPARISON VIEW ============
            const VariantComparisonView = () => {
                const getRating = (variantIndex, criterionId) => {
                // Generate consistent mock ratings based on indices
                const hash = (variantIndex * 17 + parseInt(criterionId) * 13) % 10;
                if (hash < 3) return 'negative';
                if (hash < 6) return 'neutral';
                return 'positive';
                };

                const allKriterien = Object.values(themes).flatMap(theme => 
                theme.kriterien.map(k => ({ ...k, theme: theme.name, themeColor: theme.color }))
                );

                const filteredVariants = variants.filter((_, i) => selectedVariantsForCompare.includes(i));

                return (
                <div className="flex-1 bg-white rounded-xl border border-slate-200">
                    {/* Matrix */}
                    <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                        {/* Header row with variant names */}
                        <thead>
                            <tr className="bg-slate-50">
                            <th className="sticky left-0 bg-slate-50 px-4 py-3 text-left text-sm font-medium text-slate-600 border-b border-r w-64 z-10">
                                Kriterium
                            </th>
                            {filteredVariants.map((v, i) => (
                                <th key={v.id} className="px-4 py-3 text-center border-b min-w-32">
                                <div className="text-sm font-semibold text-slate-900">{v.name}</div>
                                <div className="text-xs text-slate-500 font-normal">{v.firm}</div>
                                </th>
                            ))}
                            </tr>
                        </thead>

                        <tbody>
                            {/* Variant images row */}
                            <tr className="bg-white">
                            <td className="sticky left-0 bg-white px-4 py-3 border-b border-r z-10"></td>
                            {filteredVariants.map((v) => (
                                <td key={v.id} className="px-4 py-3 border-b">
                                <div className="w-full h-20 rounded-lg bg-slate-200 overflow-hidden">
                                    <img 
                                    src={v.thumbnail} 
                                    alt={v.name}
                                    className="w-full h-full object-cover"
                                    />
                                </div>
                                </td>
                            ))}
                            </tr>

                            {/* Summary row */}
                            <tr className="bg-emerald-50">
                            <td className="sticky left-0 bg-emerald-50 px-4 py-3 text-sm font-semibold text-emerald-800 border-b border-r z-10">
                                Gesamtbewertung
                            </td>
                            {filteredVariants.map((v, i) => {
                                const score = 60 + (selectedVariantsForCompare[i] * 7) % 30;
                                return (
                                <td key={v.id} className="px-4 py-3 text-center border-b">
                                    <div className="inline-flex items-center gap-2">
                                    <div className="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                        <div 
                                        className="h-full bg-emerald-500 rounded-full"
                                        style={{ width: `${score}%` }}
                                        />
                                    </div>
                                    <span className="text-sm font-semibold text-emerald-700">{score}%</span>
                                    </div>
                                </td>
                                );
                            })}
                            </tr>

                            {/* Criteria rows grouped by theme */}
                            {Object.values(themes).map((theme, themeIndex) => (
                            <React.Fragment key={theme.id}>
                                {/* Theme header row */}
                                <tr className="bg-slate-100">
                                <td 
                                    colSpan={filteredVariants.length + 1}
                                    className="px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wide border-b"
                                >
                                    {theme.name}
                                </td>
                                </tr>

                                {/* Criteria rows */}
                                {theme.kriterien.map((criterion, criterionIndex) => (
                                <tr key={criterion.id} className="hover:bg-slate-50">
                                    <td className="sticky left-0 bg-white hover:bg-slate-50 px-4 py-2.5 text-sm text-slate-700 border-b border-r z-10">
                                    <span className="text-slate-400 mr-2">{criterion.id}</span>
                                    {criterion.name}
                                    </td>
                                    {filteredVariants.map((v, variantIndex) => {
                                    const actualIndex = selectedVariantsForCompare[variantIndex];
                                    const rating = getRating(actualIndex, parseInt(criterion.id));
                                    const ratingSymbol = rating === 'positive' ? '+' : rating === 'neutral' ? '○' : '−';
                                    const ratingLabel = rating === 'positive' ? 'Gut' : rating === 'neutral' ? 'Mittel' : 'Schwach';
                                    return (
                                        <td key={v.id} className="px-4 py-2.5 text-center border-b">
                                        <div className="flex justify-center items-center gap-1.5">
                                            <div
                                            className={`w-5 h-5 rounded-full flex items-center justify-center text-white text-xs font-bold ${
                                                rating === 'positive' ? 'bg-emerald-500' :
                                                rating === 'neutral' ? 'bg-amber-400' :
                                                'bg-red-500'
                                            }`}
                                            title={ratingLabel}
                                            aria-label={ratingLabel}
                                            >
                                                {ratingSymbol}
                                            </div>
                                        </div>
                                        </td>
                                    );
                                    })}
                                </tr>
                                ))}
                            </React.Fragment>
                            ))}

                            {/* Kennwerte section */}
                            <tr className="bg-slate-100">
                            <td 
                                colSpan={filteredVariants.length + 1}
                                className="px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wide border-b"
                            >
                                Kennwerte
                            </td>
                            </tr>

                            {/* Key Kennwerte rows */}
                            {[
                            { id: 1, name: 'Geschossfläche GF', unit: 'm²', values: [7816, 7444, 7864, 8171, 7988] },
                            { id: 2, name: 'Gebäudevolumen GV', unit: 'm³', values: [23332, 23210, 22202, 24644, 23920] },
                            { id: 3, name: 'Flächeneffizienz NF/BGF', unit: '', values: [0.64, 0.66, 0.61, 0.61, 0.63] },
                            { id: 4, name: 'A/V-Verhältnis', unit: '', values: [0.29, 0.31, 0.28, 0.32, 0.30] },
                            { id: 5, name: 'Fensterflächenanteil', unit: '%', values: [47, 52, 44, 49, 51] },
                            { id: 6, name: 'Primärenergiebedarf', unit: '%', values: [107, 95, 112, 98, 103] },
                            ].map(kw => {
                            const selectedValues = selectedVariantsForCompare.map(i => kw.values[i]);
                            const best = kw.id === 6 ? Math.min(...selectedValues) : Math.max(...selectedValues);
                            
                            return (
                                <tr key={kw.id} className="hover:bg-slate-50">
                                <td className="sticky left-0 bg-white hover:bg-slate-50 px-4 py-2.5 text-sm text-slate-700 border-b border-r z-10">
                                    {kw.name} {kw.unit && <span className="text-slate-400">({kw.unit})</span>}
                                </td>
                                {filteredVariants.map((v, i) => {
                                    const actualIndex = selectedVariantsForCompare[i];
                                    const value = kw.values[actualIndex];
                                    const isBest = value === best;
                                    return (
                                    <td key={v.id} className="px-4 py-2.5 text-center border-b">
                                        <span className={`text-sm font-medium ${isBest ? 'text-emerald-600' : 'text-slate-700'}`}>
                                        {typeof value === 'number' && value % 1 !== 0 ? value.toFixed(2) : value.toLocaleString()}
                                        {kw.unit === '%' && '%'}
                                        </span>
                                        {isBest && <span className="ml-1 text-emerald-500">★</span>}
                                    </td>
                                    );
                                })}
                                </tr>
                            );
                            })}
                        </tbody>
                        </table>
                    </div>

                    {/* Legend */}
                    <div className="px-4 py-3 border-t flex items-center gap-6 text-sm text-slate-600">
                        <span className="font-medium">Legende:</span>
                        <div className="flex items-center gap-2">
                            <div className="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs font-bold">+</div>
                            <span>Gut</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-5 h-5 rounded-full bg-amber-400 flex items-center justify-center text-white text-xs font-bold">○</div>
                            <span>Mittel</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-white text-xs font-bold">−</div>
                            <span>Schwach</span>
                        </div>
                        <div className="flex items-center gap-2 ml-4">
                            <span className="text-emerald-500 text-lg">★</span>
                            <span>Bester Wert</span>
                        </div>
                    </div>
                </div>
                );
            };

            // ============ EVALUATION CONTENT VIEW ============
            const EvaluationContentView = () => (
                <div className="flex-1 space-y-4">
                    <VariantHeaderCard />
                    <SNAPKriterienSection />
                </div>
            );

            // ============ RENDER ============
            const showVariantList = currentProject && sidebarView !== 'overview';

            // Gallery view (no project selected)
            if (!currentProject) {
                return (
                    <div className="min-h-screen flex flex-col bg-slate-50">
                        <AppHeader />
                        <ProjectGalleryView />
                        <CreateProjectModal />
                    </div>
                );
            }

            // Project view (project selected)
            return (
                <div className="min-h-screen flex flex-col bg-slate-100">
                <AppHeader />
                <NavigationBreadcrumb />
                {/* Full-width background, max-width content container */}
                <div className="flex-1">
                    <div className="max-w-[1400px] mx-auto p-6 flex gap-6">
                        <MainSidebar />
                        <div className="flex-1 flex gap-6 items-start">
                            {showVariantList && <VariantSelectorList />}
                            {sidebarView === 'overview' ? <ProjectOverviewView /> :
                            sidebarView === 'comparison' ? <VariantComparisonView /> :
                            sidebarView === 'model3d' ? <Model3DViewer /> :
                            <EvaluationContentView />}
                        </div>
                    </div>
                </div>
                <CreateProjectModal />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SustainabilityApp />);
    </script>
</body>
</html>
