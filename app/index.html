<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wettbewerb Cockpit</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- External Dependencies (Icons & Maps only) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />


    <!-- App Styles (includes design tokens) -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="root"></div>

    <script>
/* ========================================
   VANILLA JS APPLICATION
   ======================================== */

// ============================================
// STATE MANAGEMENT
// ============================================
const createStore = (initialState) => {
    let state = { ...initialState };
    const listeners = new Set();

    return {
        getState: () => state,
        get: (key) => state[key],
        set: (key, value) => {
            if (state[key] !== value) {
                state[key] = value;
                listeners.forEach(fn => fn(state, key));
            }
        },
        update: (updates) => {
            state = { ...state, ...updates };
            listeners.forEach(fn => fn(state, Object.keys(updates)));
        },
        subscribe: (fn) => {
            listeners.add(fn);
            return () => listeners.delete(fn);
        }
    };
};

// Application State
const store = createStore({
    role: 'admin',
    currentProject: null,
    galleryViewMode: 'grid',
    sidebarView: 'overview',
    selectedVariant: 0,
    selectedVariantsForCompare: [0, 1, 2, 3, 4],
    isEditMode: false,
    expandedThemes: ['functionality'],
    has3DModel: true,
    isCreateModalOpen: false,
    criteriaData: {},
    searchQuery: '',
    statusFilter: 'all',
    usageFilter: 'all',
    // New state for enhanced features
    collapsedSections: {},
    isVariantDropdownOpen: false,
    isEditingAddress: false,
    editingAddress: '',
    projectImages: [], // Will be populated from data.json or current project
    formErrors: {},
    isSubmitting: false,
    isMobileSidebarOpen: false
});

// ============================================
// DOM UTILITIES
// ============================================
const el = (tag, attrs = {}, children = []) => {
    const element = document.createElement(tag);

    Object.entries(attrs).forEach(([key, value]) => {
        if (key === 'className') {
            element.className = value;
        } else if (key === 'style' && typeof value === 'object') {
            Object.assign(element.style, value);
        } else if (key.startsWith('on') && typeof value === 'function') {
            const event = key.slice(2).toLowerCase();
            element.addEventListener(event, value);
        } else if (key === 'dataset') {
            Object.entries(value).forEach(([k, v]) => element.dataset[k] = v);
        } else if (value !== undefined && value !== null && value !== false) {
            element.setAttribute(key, value);
        }
    });

    const appendChildren = (items) => {
        items.forEach(child => {
            if (child === null || child === undefined) return;
            if (typeof child === 'string' || typeof child === 'number') {
                element.appendChild(document.createTextNode(child));
            } else if (child instanceof Node) {
                element.appendChild(child);
            } else if (Array.isArray(child)) {
                appendChildren(child);
            }
        });
    };

    appendChildren(Array.isArray(children) ? children : [children]);
    return element;
};

const render = (component, container) => {
    container.innerHTML = '';
    const element = typeof component === 'function' ? component() : component;
    if (element) container.appendChild(element);
};

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// ============================================
// DATA (loaded from data.json)
// ============================================
let APP_DATA = null;
let MAPBOX_TOKEN = '';
let VARIANTS = [];
let PROJECTS = [];
let THEMES = {};

const loadAppData = async () => {
    try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('Failed to load data.json');
        APP_DATA = await response.json();

        // Populate global data references
        MAPBOX_TOKEN = APP_DATA.config.mapbox.token;
        VARIANTS = APP_DATA.variants;
        PROJECTS = APP_DATA.projects;
        THEMES = APP_DATA.themes;

        // Set default images in store
        store.set('projectImages', APP_DATA.config.defaultImages || []);

        return APP_DATA;
    } catch (error) {
        console.error('Error loading app data:', error);
        // Show error to user
        document.getElementById('root').innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--color-red-600);">
                <h2>Error Loading Data</h2>
                <p>Could not load application data. Please check that data.json exists.</p>
                <pre style="text-align: left; background: var(--color-slate-100); padding: 1rem; border-radius: 0.5rem;">${error.message}</pre>
            </div>
        `;
        throw error;
    }
};

// Helper to get project images (from current project or defaults)
const getProjectImages = () => {
    const currentProject = store.get('currentProject');
    if (currentProject?.images?.length > 0) {
        return currentProject.images;
    }
    return APP_DATA?.config?.defaultImages || store.get('projectImages');
};

// Mock data generators
const generateKennwertData = (variantIndex, kennwerte) => {
    return kennwerte.map((k, i) => {
        const baseValue = 50 + (variantIndex * 7 + i * 13) % 50;
        const avgValue = 60 + (i * 11) % 30;
        const rank = ((variantIndex + i) % 5) + 1;
        const delta = baseValue - avgValue;
        return { ...k, value: baseValue, avg: avgValue, rank, total: 5, delta };
    });
};

const generateKriterienData = (variantIndex, kriterien) => {
    const defaultRatings = ['positive', 'neutral', 'negative'];
    const defaultComments = [
        'Vorfahrt eingeschränkt berücksichtigt; Ver- und Entsorgung bedingt funktionstüchtig; günstige Positionierung Fahrradabstellplätze;',
        'Gebäude eingeschränkt barrierefrei; Barrierefreiheit Aussenraum k. A. / unklar (Freitreppe);',
        'vielfältiges Angebot im Gebäude (Ausstellung, Präsentation); vielfältiges Angebot im Aussenraum;',
    ];
    return kriterien.map((k, i) => {
        const criteriaData = store.get('criteriaData');
        const storedData = criteriaData[variantIndex]?.[k.id];
        const defaultRating = defaultRatings[(variantIndex + i) % 3];
        const defaultComment = defaultComments[(variantIndex + i) % defaultComments.length];
        return {
            ...k,
            rating: storedData?.rating || defaultRating,
            comment: storedData?.comment !== undefined ? storedData.comment : defaultComment
        };
    });
};

// ============================================
// BASE COMPONENTS
// ============================================
const Icon = (name, { size = 20, className = '' } = {}) => {
    return el('span', {
        className: `material-symbols-outlined material-icon size-${size} ${className}`,
        style: { fontSize: `${size}px` },
        'aria-hidden': 'true'
    }, [name]);
};

const Button = ({ children, variant = 'primary', size = 'md', icon, iconRight, onClick, disabled, className = '' }) => {
    const content = [];
    if (icon && !iconRight) content.push(Icon(icon, { size: size === 'sm' ? 14 : size === 'lg' ? 20 : 16 }));
    if (children) content.push(typeof children === 'string' ? children : children);
    if (icon && iconRight) content.push(Icon(icon, { size: size === 'sm' ? 14 : size === 'lg' ? 20 : 16 }));

    return el('button', {
        className: `btn btn-${variant} btn-${size} ${className}`,
        onclick: onClick,
        disabled
    }, content);
};

const Badge = ({ status, label, showDot = true, size = 'md' }) => {
    const content = [];
    if (showDot) content.push(el('span', { className: 'badge-dot' }));
    content.push(label);
    return el('span', { className: `badge badge-${status} badge-${size}` }, content);
};

const Avatar = ({ name, src, size = 'md', className = '' }) => {
    const getInitials = (n) => n ? n.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2) : '?';

    if (src) {
        return el('div', { className: `avatar avatar-${size} ${className}` }, [
            el('img', { src, alt: name })
        ]);
    }
    return el('div', {
        className: `avatar avatar-${size} avatar-default ${className}`,
        title: name
    }, [getInitials(name)]);
};

const LabelValue = ({ label, value }) => {
    return el('div', { className: 'label-value' }, [
        el('div', { className: 'label-value-label' }, [label]),
        el('div', { className: 'label-value-value' }, [value])
    ]);
};

const ProgressBar = ({ value, max = 100, color = 'emerald', size = 'md' }) => {
    const percentage = Math.min(100, Math.max(0, (value / max) * 100));
    return el('div', { className: `progress-bar progress-bar-${size}` }, [
        el('div', {
            className: `progress-bar-fill progress-bar-${color}`,
            style: { width: `${percentage}%` }
        })
    ]);
};

const StatCard = ({ icon, value, label }) => {
    return el('div', { className: 'stat-card' }, [
        el('div', { className: 'stat-icon' }, [Icon(icon, { size: 20, className: 'text-slate-500' })]),
        el('div', {}, [
            el('div', { className: 'stat-value' }, [value]),
            el('div', { className: 'stat-label' }, [label])
        ])
    ]);
};

// ============================================
// HEADER COMPONENT
// ============================================
const AppHeader = () => {
    const currentProject = store.get('currentProject');

    const HeaderAction = ({ icon, label, badge }) => {
        return el('button', { className: 'header-action', title: label, 'aria-label': label }, [
            Icon(icon, { size: 20 }),
            badge ? el('span', { className: 'header-action-badge' }) : null
        ]);
    };

    return el('header', { className: 'app-header' }, [
        el('a', { href: '../index.html', className: 'header-brand-link', title: 'Zur Landing Page' }, [
            el('span', { className: 'header-logo' }, [Icon('analytics', { size: 28 })]),
            el('span', { className: 'header-title' }, ['Wettbewerb Cockpit']),
            currentProject ? el('span', { className: 'header-breadcrumb' }, ['/']) : null,
            currentProject ? el('span', { className: 'header-project-name' }, [currentProject.name]) : null
        ]),
        el('div', { className: 'flex items-center gap-1' }, [
            HeaderAction({ icon: 'help_outline', label: 'Hilfe' }),
            HeaderAction({ icon: 'notifications', label: 'Benachrichtigungen', badge: true }),
            HeaderAction({ icon: 'settings', label: 'Einstellungen' }),
            el('div', { className: 'header-divider' }),
            el('button', { className: 'flex items-center gap-2 p-1 rounded-lg hover\\:bg-slate-100 transition-colors' }, [
                Avatar({ name: 'David Admin', size: 'md', className: 'bg-slate-200 text-slate-600' })
            ])
        ])
    ]);
};

// ============================================
// SIDEBAR COMPONENT
// ============================================
const MainSidebar = () => {
    const sidebarView = store.get('sidebarView');
    const has3DModel = store.get('has3DModel');
    const isMobileSidebarOpen = store.get('isMobileSidebarOpen');

    const items = [
        { id: 'overview', label: 'Übersicht', icon: 'home' },
        { id: 'evaluation', label: 'Bewertung', icon: 'rate_review' },
        { id: 'model3d', label: '3D Modell', icon: 'view_in_ar', requires3D: true },
        { id: 'comparison', label: 'Vergleich', icon: 'compare' },
    ].filter(item => !item.requires3D || has3DModel);

    const closeMobileSidebar = () => {
        store.set('isMobileSidebarOpen', false);
        renderApp();
    };

    return el('aside', { className: `sidebar ${isMobileSidebarOpen ? 'mobile-open' : ''}` }, [
        el('nav', { className: 'sidebar-nav' }, items.map(item =>
            el('button', {
                className: `sidebar-item ${sidebarView === item.id ? 'active' : ''}`,
                onclick: () => {
                    store.update({ sidebarView: item.id, isMobileSidebarOpen: false });
                    renderApp();
                },
                title: item.label
            }, [
                el('div', { className: 'sidebar-item-icon' }, [
                    Icon(item.icon, { size: 22, className: sidebarView === item.id ? 'text-slate-700' : 'text-slate-400' })
                ]),
                el('span', { className: 'sidebar-item-label' }, [item.label])
            ])
        ))
    ]);
};

// Mobile Sidebar Toggle Button
const MobileSidebarToggle = () => {
    const toggleSidebar = () => {
        store.set('isMobileSidebarOpen', !store.get('isMobileSidebarOpen'));
        renderApp();
    };

    return el('button', {
        className: 'sidebar-toggle',
        onclick: toggleSidebar,
        'aria-label': 'Navigation öffnen'
    }, [
        Icon('menu', { size: 24 })
    ]);
};

// Mobile Sidebar Overlay
const MobileSidebarOverlay = () => {
    const isOpen = store.get('isMobileSidebarOpen');
    if (!isOpen) return null;

    return el('div', {
        className: 'sidebar-overlay active',
        onclick: () => {
            store.set('isMobileSidebarOpen', false);
            renderApp();
        }
    });
};

// ============================================
// BREADCRUMB COMPONENT
// ============================================
const VariantDropdownSelector = () => {
    const selectedVariant = store.get('selectedVariant');
    const isOpen = store.get('isVariantDropdownOpen');
    const variant = VARIANTS[selectedVariant];

    const toggleDropdown = (e) => {
        e.stopPropagation();
        store.set('isVariantDropdownOpen', !isOpen);
        renderApp();
    };

    const selectVariant = (index) => {
        store.update({ selectedVariant: index, isVariantDropdownOpen: false });
        renderApp();
    };

    // Close dropdown when clicking outside
    if (isOpen) {
        setTimeout(() => {
            const closeDropdown = (e) => {
                if (!e.target.closest('.variant-dropdown')) {
                    store.set('isVariantDropdownOpen', false);
                    renderApp();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            document.addEventListener('click', closeDropdown);
        }, 0);
    }

    return el('div', { className: 'variant-dropdown' }, [
        el('button', {
            className: 'variant-dropdown-trigger',
            onclick: toggleDropdown
        }, [
            variant.name,
            Icon('expand_more', { size: 16 })
        ]),
        isOpen ? el('div', { className: 'variant-dropdown-menu' },
            VARIANTS.map((v, i) =>
                el('button', {
                    className: `variant-dropdown-item ${i === selectedVariant ? 'active' : ''}`,
                    onclick: () => selectVariant(i)
                }, [
                    el('div', { className: 'variant-dropdown-thumb' }, [
                        el('img', { src: v.thumbnail, alt: v.name })
                    ]),
                    el('div', {}, [
                        el('div', { className: 'text-sm font-medium' }, [v.name]),
                        el('div', { className: 'text-xs text-slate-500' }, [v.code])
                    ])
                ])
            )
        ) : null
    ]);
};

const Breadcrumb = () => {
    const currentProject = store.get('currentProject');
    const sidebarView = store.get('sidebarView');
    const selectedVariant = store.get('selectedVariant');

    if (!currentProject) return null;

    const viewLabels = {
        overview: 'Übersicht', evaluation: 'Bewertung',
        model3d: '3D Modell', comparison: 'Vergleich'
    };

    const items = [
        { label: 'Projekte', icon: 'folder', onClick: () => { store.set('currentProject', null); renderApp(); } },
        { label: currentProject.name, onClick: () => { store.set('sidebarView', 'overview'); renderApp(); }, active: sidebarView === 'overview' }
    ];

    if (sidebarView !== 'overview' && sidebarView !== 'comparison') {
        items[1].active = false;
        items.push({ label: VARIANTS[selectedVariant].name, isDropdown: true });
        items.push({ label: viewLabels[sidebarView], active: true });
    } else if (sidebarView === 'comparison') {
        items[1].active = false;
        items.push({ label: viewLabels.comparison, active: true });
    }

    // Check if we are in comparison view for the container class
    const isComparisonView = sidebarView === 'comparison';

    // HIERARCHY FIX:
    // 1. "breadcrumb-bar" provides the background/border (full width).
    // 2. "breadcrumb-container" handles the max-width/centering logic (mirrors project-layout).
    // 3. "breadcrumb-list" handles the 98px offset relative to the container.
    return el('nav', { className: 'breadcrumb-bar' }, [
        el('div', { className: `breadcrumb-container ${isComparisonView ? 'comparison-view' : ''}` }, [
            el('ol', { className: 'breadcrumb-list' }, items.map((item, i) =>
                el('li', { className: 'breadcrumb-item' }, [
                    i > 0 ? el('span', { className: 'breadcrumb-separator' }, [Icon('chevron_right', { size: 16 })]) : null,
                    item.isDropdown ?
                        VariantDropdownSelector() :
                    item.onClick ?
                        el('button', {
                            className: `breadcrumb-link ${item.active ? 'active' : ''}`,
                            onclick: item.onClick
                        }, [
                            item.icon ? Icon(item.icon, { size: 14 }) : null,
                            item.label
                        ]) :
                        el('span', { className: `breadcrumb-link ${item.active ? 'active' : ''}` }, [item.label])
                ])
            ))
        ])
    ]);
};

// ============================================
// VARIANT SELECTOR COMPONENT
// ============================================
const VariantSelector = () => {
    const sidebarView = store.get('sidebarView');
    const selectedVariant = store.get('selectedVariant');
    const selectedVariantsForCompare = store.get('selectedVariantsForCompare');
    const isComparisonView = sidebarView === 'comparison';

    const handleClick = (index) => {
        if (isComparisonView) {
            const current = [...selectedVariantsForCompare];
            if (current.includes(index)) {
                if (current.length > 1) {
                    store.set('selectedVariantsForCompare', current.filter(i => i !== index).sort((a, b) => a - b));
                }
            } else {
                store.set('selectedVariantsForCompare', [...current, index].sort((a, b) => a - b));
            }
        } else {
            store.set('selectedVariant', index);
        }
        renderApp();
    };

    return el('div', { className: 'variant-list' }, [
        el('div', { className: 'variant-list-header' }, [
            el('div', { className: 'variant-list-title' }, ['Varianten']),
            el('span', { className: 'variant-list-count' }, [String(VARIANTS.length)])
        ]),
        el('div', { className: 'variant-list-items' }, VARIANTS.map((v, i) => {
            const isSelected = isComparisonView ? selectedVariantsForCompare.includes(i) : selectedVariant === i;
            return el('button', {
                className: `variant-item ${isSelected ? 'selected' : ''}`,
                onclick: () => handleClick(i)
            }, [
                el('div', { className: 'variant-thumbnail' }, [
                    el('img', { src: v.thumbnail, alt: v.name }),
                    el('span', { className: 'variant-code' }, [v.code])
                ]),
                el('div', { className: 'variant-name' }, [v.name]),
                el('div', { className: 'variant-firm' }, [v.firm])
            ]);
        }))
    ]);
};

// ============================================
// PROJECT CARD COMPONENT
// ============================================
const ProjectCard = (project) => {
    return el('div', {
        className: 'project-card',
        onclick: () => {
            store.set('currentProject', project);
            store.set('sidebarView', 'overview');
            renderApp();
        },
        tabindex: '0',
        role: 'button'
    }, [
        el('div', { className: 'project-card-thumbnail' }, [
            el('img', { src: project.thumbnail, alt: project.name }),
            el('div', { className: 'project-card-gradient' }),
            el('span', { className: 'project-card-id' }, [String(project.id).padStart(4, '0')]),
            el('div', { className: 'project-card-status' }, [Badge({ status: project.status, label: project.statusLabel })]),
            el('div', { className: 'project-card-info' }, [
                el('div', { className: 'project-card-name' }, [project.name]),
                el('div', { className: 'project-card-address' }, [project.address])
            ])
        ]),
        el('div', { className: 'project-card-body' }, [
            el('div', { className: 'project-card-meta' }, [
                LabelValue({ label: 'Nutzung', value: project.usageType }),
                LabelValue({ label: 'Framework', value: project.framework })
            ]),
            el('div', { className: 'project-card-footer' }, [
                el('div', { className: 'flex items-center gap-4' }, [
                    el('div', { className: 'project-card-stat' }, [
                        Icon('apartment', { size: 16, className: 'text-slate-400' }),
                        `${project.variantCount} Varianten`
                    ]),
                    el('div', { className: 'project-card-stat' }, [
                        Icon('check_circle', { size: 16, className: 'text-emerald-500' }),
                        `${project.evaluatedCount} bewertet`
                    ])
                ])
            ])
        ])
    ]);
};

// ============================================
// PROJECT LIST ROW COMPONENT
// ============================================
const ProjectListRow = (project) => {
    return el('tr', {
        className: 'table-row-clickable',
        onclick: () => {
            store.set('currentProject', project);
            store.set('sidebarView', 'overview');
            renderApp();
        }
    }, [
        el('td', {}, [
            el('div', { className: 'font-medium text-slate-900' }, [project.name]),
            el('div', { className: 'text-sm text-slate-500' }, [project.address])
        ]),
        el('td', { className: 'text-slate-600' }, [project.usageType]),
        el('td', { className: 'text-slate-600' }, [project.framework]),
        el('td', { className: 'text-slate-600' }, [project.phase]),
        el('td', {}, [Badge({ status: project.status, label: project.statusLabel })]),
        el('td', { className: 'text-slate-600' }, [String(project.variantCount)]),
        el('td', { className: 'text-slate-500' }, [project.lastUpdated])
    ]);
};

// ============================================
// PROJECTS MAP INITIALIZATION
// ============================================
let projectsMapInstance = null;

const initProjectsMap = (projects) => {
    const mapContainer = document.getElementById('projects-map');
    if (!mapContainer || !window.mapboxgl) return;

    // Prevent re-initialization
    if (mapContainer.dataset.initialized === 'true') return;
    mapContainer.dataset.initialized = 'true';

    // Create map
    const map = new mapboxgl.Map({
        container: 'projects-map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.54, 47.38], // Zürich center
        zoom: 11,
        accessToken: MAPBOX_TOKEN
    });

    projectsMapInstance = map;

    // Add markers for each project
    projects.forEach(project => {
        if (!project.coordinates) return;

        // Create custom marker element using CSS classes
        const markerEl = document.createElement('div');
        const statusClass = project.status === 'completed' ? 'map-marker--completed'
            : project.status === 'active' ? 'map-marker--active'
            : 'map-marker--draft';
        markerEl.className = `map-marker ${statusClass}`;
        markerEl.innerHTML = `<span class="map-marker__count">${project.variantCount}</span>`;

        // Create popup
        const popup = new mapboxgl.Popup({ offset: 25, closeButton: false })
            .setHTML(`
                <div style="padding: 8px; min-width: 200px;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${project.name}</div>
                    <div style="font-size: 12px; color: #4b5563; margin-bottom: 8px;">${project.address}</div>
                    <div style="display: flex; gap: 12px; font-size: 12px;">
                        <span>${project.variantCount} Varianten</span>
                        <span style="color: #10b981;">${project.evaluatedCount} bewertet</span>
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #d1d5db;">
                        <span style="font-size: 11px; color: #6b7280;">${project.framework} · ${project.phase}</span>
                    </div>
                </div>
            `);

        // Add marker to map
        const marker = new mapboxgl.Marker(markerEl)
            .setLngLat([project.coordinates.lng, project.coordinates.lat])
            .setPopup(popup)
            .addTo(map);

        // Click to open project
        markerEl.addEventListener('click', () => {
            store.set('currentProject', project);
            store.set('sidebarView', 'overview');
            renderApp();
        });
    });

    // Fit bounds to show all markers
    if (projects.length > 0) {
        const bounds = new mapboxgl.LngLatBounds();
        projects.forEach(p => {
            if (p.coordinates) {
                bounds.extend([p.coordinates.lng, p.coordinates.lat]);
            }
        });
        map.fitBounds(bounds, { padding: 50 });
    }
};

// ============================================
// GALLERY VIEW COMPONENT
// ============================================
const GalleryView = () => {
    const viewMode = store.get('galleryViewMode');
    const searchQuery = store.get('searchQuery');
    const statusFilter = store.get('statusFilter');
    const usageFilter = store.get('usageFilter');

    const filteredProjects = PROJECTS.filter(p => {
        const matchesSearch = !searchQuery ||
            p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            p.address.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesStatus = statusFilter === 'all' || p.status === statusFilter;
        const matchesUsage = usageFilter === 'all' || p.usageType === usageFilter;
        return matchesSearch && matchesStatus && matchesUsage;
    });

    const totalProjects = PROJECTS.length;
    const activeProjects = PROJECTS.filter(p => p.status === 'active').length;
    const completedProjects = PROJECTS.filter(p => p.status === 'completed').length;
    const usageTypes = [...new Set(PROJECTS.map(p => p.usageType))];

    const ViewToggleBtn = (mode, icon, label) => {
        return el('button', {
            className: `view-toggle-btn ${viewMode === mode ? 'active' : ''}`,
            onclick: () => { store.set('galleryViewMode', mode); renderApp(); },
            title: label
        }, [Icon(icon, { size: 20 })]);
    };

    return el('div', { className: 'flex-1 bg-slate-50' }, [
        // Header
        el('div', { className: 'gallery-header' }, [
            el('div', { className: 'gallery-header-content' }, [
                el('div', { className: 'flex items-center justify-between mb-4' }, [
                    el('div', {}, [
                        el('h1', { className: 'text-2xl font-bold text-slate-900' }, ['Projekte']),
                        el('p', { className: 'text-sm text-slate-500 mt-1' }, [
                            filteredProjects.length === totalProjects
                                ? `${totalProjects} Projekte · ${activeProjects} aktiv · ${completedProjects} abgeschlossen`
                                : `${filteredProjects.length} von ${totalProjects} Projekten`
                        ])
                    ]),
                    el('div', { className: 'flex items-center gap-3' }, [
                        el('div', { className: 'view-toggle' }, [
                            ViewToggleBtn('grid', 'grid_view', 'Galerieansicht'),
                            ViewToggleBtn('list', 'view_list', 'Listenansicht'),
                            ViewToggleBtn('map', 'map', 'Kartenansicht')
                        ]),
                        Button({
                            children: 'Neues Projekt',
                            icon: 'add',
                            onClick: () => { store.set('isCreateModalOpen', true); renderApp(); }
                        })
                    ])
                ]),
                // Filters
                el('div', { className: 'flex items-center gap-3' }, [
                    el('div', { className: 'search-wrapper' }, [
                        el('span', { className: 'search-icon' }, [Icon('search', { size: 18 })]),
                        el('input', {
                            type: 'text',
                            className: 'search-input',
                            placeholder: 'Projekt suchen...',
                            value: searchQuery,
                            oninput: (e) => { store.set('searchQuery', e.target.value); renderApp(); }
                        }),
                        searchQuery ? el('button', {
                            className: 'search-clear',
                            onclick: () => { store.set('searchQuery', ''); renderApp(); }
                        }, [Icon('close', { size: 16 })]) : null
                    ]),
                    el('select', {
                        className: 'filter-select select',
                        value: statusFilter,
                        onchange: (e) => { store.set('statusFilter', e.target.value); renderApp(); }
                    }, [
                        el('option', { value: 'all' }, ['Alle Status']),
                        el('option', { value: 'active' }, ['Aktiv']),
                        el('option', { value: 'completed' }, ['Abgeschlossen']),
                        el('option', { value: 'draft' }, ['Entwurf'])
                    ]),
                    el('select', {
                        className: 'filter-select select',
                        value: usageFilter,
                        onchange: (e) => { store.set('usageFilter', e.target.value); renderApp(); }
                    }, [
                        el('option', { value: 'all' }, ['Alle Nutzungen']),
                        ...usageTypes.map(type => el('option', { value: type }, [type]))
                    ]),
                    // Clear Filters Button (shows when any filter is active)
                    (searchQuery || statusFilter !== 'all' || usageFilter !== 'all') ?
                        el('button', {
                            className: 'filter-reset-btn',
                            onclick: () => {
                                store.update({ searchQuery: '', statusFilter: 'all', usageFilter: 'all' });
                                renderApp();
                            }
                        }, [
                            Icon('filter_alt_off', { size: 16 }),
                            'Filter zurücksetzen'
                        ]) : null
                ])
            ])
        ]),
        // Content
        el('div', { className: 'gallery-content' }, [
            filteredProjects.length === 0 ?
                el('div', { className: 'card' }, [
                    el('div', { className: 'empty-state' }, [
                        el('div', { className: 'empty-state-icon' }, [Icon('search_off', { size: 32, className: 'text-slate-400' })]),
                        el('h3', { className: 'empty-state-title' }, ['Keine Projekte gefunden']),
                        el('p', { className: 'empty-state-desc' }, ['Versuchen Sie, Ihre Suchkriterien anzupassen.']),
                        Button({
                            children: 'Filter zurücksetzen',
                            onClick: () => {
                                store.update({ searchQuery: '', statusFilter: 'all', usageFilter: 'all' });
                                renderApp();
                            }
                        })
                    ])
                ]) :
            viewMode === 'grid' ?
                el('div', { className: 'gallery-grid' }, filteredProjects.map(p => ProjectCard(p))) :
            viewMode === 'list' ?
                el('div', { className: 'table-wrapper' }, [
                    el('table', { className: 'table' }, [
                        el('thead', {}, [
                            el('tr', {}, [
                                el('th', {}, ['Projekt']),
                                el('th', {}, ['Nutzung']),
                                el('th', {}, ['Framework']),
                                el('th', {}, ['Phase']),
                                el('th', {}, ['Status']),
                                el('th', {}, ['Varianten']),
                                el('th', {}, ['Aktualisiert'])
                            ])
                        ]),
                        el('tbody', {}, filteredProjects.map(p => ProjectListRow(p)))
                    ])
                ]) :
                (() => {
                    // Initialize map after render
                    setTimeout(() => initProjectsMap(filteredProjects), 100);
                    return el('div', { className: 'card', style: { height: '600px' } }, [
                        el('div', { id: 'projects-map', className: 'h-full w-full rounded-lg' })
                    ]);
                })()
        ])
    ]);
};

// ============================================
// COLLAPSIBLE SECTION COMPONENT
// ============================================
const CollapsibleSection = ({ id, icon, title, badge, actions, children, defaultOpen = true }) => {
    const collapsedSections = store.get('collapsedSections');
    const isCollapsed = collapsedSections[id] ?? !defaultOpen;

    const toggle = () => {
        const updated = { ...collapsedSections, [id]: !isCollapsed };
        store.set('collapsedSections', updated);
        renderApp();
    };

    return el('div', { className: `collapsible ${!isCollapsed ? 'expanded' : ''}` }, [
        el('button', { className: 'collapsible-header flex items-center gap-3 w-full', onclick: toggle }, [
            el('div', { className: 'collapsible-icon-wrapper' }, [Icon(icon, { size: 18, className: 'text-slate-600' })]),
            el('span', { className: 'collapsible-title flex-1 text-left' }, [title]),
            badge ? el('span', { className: 'collapsible-badge' }, [badge]) : null,
            actions ? el('div', { className: 'collapsible-actions', onclick: e => e.stopPropagation() }, actions) : null,
            Icon(isCollapsed ? 'expand_more' : 'expand_less', { size: 20, className: 'text-slate-400' })
        ]),
        !isCollapsed ? el('div', { className: 'collapsible-content' }, children) : null
    ]);
};

// ============================================
// TEAM MEMBER ROW COMPONENT
// ============================================
const TeamMemberRow = ({ name, email, role, isExpert = false }) => {
    return el('div', { className: 'team-member-row' }, [
        el('div', { className: 'team-member-info' }, [
            Avatar({
                name,
                size: 'md',
                className: isExpert ? 'bg-emerald-100 text-emerald-700' : ''
            }),
            el('div', { className: 'team-member-details' }, [
                el('span', { className: 'team-member-name' }, [name]),
                el('span', { className: 'team-member-email' }, [email])
            ])
        ]),
        el('span', { className: `team-role-badge ${isExpert ? 'expert' : ''}` }, [role])
    ]);
};

// ============================================
// MAP SECTION COMPONENT
// ============================================
const MapSection = () => {
    const currentProject = store.get('currentProject');
    const isEditingAddress = store.get('isEditingAddress');
    const editingAddress = store.get('editingAddress');

    const startEditing = () => {
        store.update({ isEditingAddress: true, editingAddress: currentProject?.address || '' });
        renderApp();
    };

    const cancelEditing = () => {
        store.update({ isEditingAddress: false, editingAddress: '' });
        renderApp();
    };

    const saveAddress = () => {
        // In real app would geocode and update coordinates
        store.update({ isEditingAddress: false, editingAddress: '' });
        renderApp();
    };

    // Initialize map after render
    setTimeout(() => {
        const mapContainer = document.getElementById('project-map');
        if (mapContainer && !mapContainer.dataset.initialized && window.mapboxgl) {
            mapContainer.dataset.initialized = 'true';
            const coords = currentProject?.coordinates || { lat: 47.3769, lng: 8.5017 };
            const map = new mapboxgl.Map({
                container: 'project-map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [coords.lng, coords.lat],
                zoom: 15,
                accessToken: MAPBOX_TOKEN
            });
            new mapboxgl.Marker({ color: '#475569' })
                .setLngLat([coords.lng, coords.lat])
                .addTo(map);
        }
    }, 100);

    return CollapsibleSection({
        id: 'map',
        icon: 'location_on',
        title: 'Standort',
        actions: [
            !isEditingAddress ? Button({
                children: 'Bearbeiten',
                variant: 'ghost',
                size: 'sm',
                icon: 'edit',
                onClick: startEditing
            }) : null
        ],
        children: [
            isEditingAddress ?
                el('div', { className: 'map-edit-form' }, [
                    el('input', {
                        type: 'text',
                        className: 'input',
                        value: editingAddress,
                        placeholder: 'Adresse eingeben...',
                        oninput: (e) => store.set('editingAddress', e.target.value)
                    }),
                    Button({ children: 'Speichern', size: 'sm', onClick: saveAddress }),
                    Button({ children: 'Abbrechen', variant: 'ghost', size: 'sm', onClick: cancelEditing })
                ]) :
                el('div', { className: 'map-address' }, [
                    Icon('place', { size: 16, className: 'text-slate-400' }),
                    currentProject?.address || 'Badenerstrasse 501, 8048 Zürich'
                ]),
            el('div', { id: 'project-map', className: 'map-container bg-slate-200' })
        ]
    });
};

// ============================================
// IMAGE GALLERY SECTION COMPONENT
// ============================================
const ImageGallerySection = () => {
    const currentProject = store.get('currentProject');
    // Use project-specific images, falling back to store images (for new/default projects)
    const projectImages = currentProject?.images?.length > 0
        ? currentProject.images
        : store.get('projectImages');
    const isEditMode = store.get('isEditMode');

    const deleteImage = (index) => {
        const images = [...projectImages];
        images.splice(index, 1);
        store.set('projectImages', images);
        renderApp();
    };

    const handleUpload = () => {
        // Simulate adding a new image
        const newImages = [...projectImages, 'https://images.unsplash.com/photo-1448630360428-65456885c650?w=400&h=400&fit=crop'];
        store.set('projectImages', newImages);
        renderApp();
    };

    return CollapsibleSection({
        id: 'gallery',
        icon: 'photo_library',
        title: 'Bilder',
        badge: `${projectImages.length} Bilder`,
        actions: [
            Button({
                children: isEditMode ? 'Fertig' : 'Bearbeiten',
                variant: 'ghost',
                size: 'sm',
                icon: isEditMode ? 'check' : 'edit',
                onClick: () => { store.set('isEditMode', !isEditMode); renderApp(); }
            })
        ],
        children: [
            el('div', { className: 'image-gallery-grid' },
                projectImages.map((img, i) =>
                    el('div', { className: 'image-gallery-item' }, [
                        el('img', { src: img, alt: `Bild ${i + 1}` }),
                        el('div', { className: 'overlay' }),
                        isEditMode ? el('button', {
                            className: 'delete-btn',
                            onclick: () => deleteImage(i)
                        }, [Icon('close', { size: 14 })]) : null
                    ])
                )
            ),
            el('div', { className: 'image-upload-zone', onclick: handleUpload }, [
                el('div', { className: 'flex flex-col items-center gap-2' }, [
                    Icon('cloud_upload', { size: 32, className: 'text-slate-400' }),
                    el('span', { className: 'text-sm text-slate-600' }, ['Weitere Bilder hinzufügen']),
                    el('span', { className: 'text-xs text-slate-400' }, ['oder Dateien hierher ziehen'])
                ])
            ])
        ]
    });
};

// ============================================
// PROJECT OVERVIEW VIEW COMPONENT
// ============================================
const ProjectOverviewView = () => {
    const currentProject = store.get('currentProject');

    // Get project-specific data from JSON, with fallbacks
    const teamMembers = currentProject?.team || [];
    const experts = currentProject?.experts || [];
    const milestones = currentProject?.milestones || [];

    return el('div', { className: 'flex-1 space-y-4' }, [
        // Quick Actions
        el('div', { className: 'card' }, [
            el('div', { className: 'card-body' }, [
                el('div', { className: 'flex items-center justify-between' }, [
                    el('div', { className: 'flex items-center gap-3' }, [
                        el('div', { className: 'collapsible-icon-wrapper' }, [Icon('bolt', { size: 18, className: 'text-slate-600' })]),
                        el('span', { className: 'font-semibold text-slate-900' }, ['Schnellaktionen'])
                    ]),
                    el('div', { className: 'flex flex-wrap gap-2' }, [
                        Button({ children: 'Bericht exportieren', variant: 'secondary', size: 'sm', icon: 'download' }),
                        Button({ children: 'Projekt teilen', variant: 'secondary', size: 'sm', icon: 'share' }),
                        Button({ children: 'Archivieren', variant: 'secondary', size: 'sm', icon: 'archive' })
                    ])
                ])
            ])
        ]),
        // Project Header Card
        el('div', { className: 'card' }, [
            el('div', { className: 'card-body' }, [
                el('div', { className: 'flex items-start justify-between mb-6' }, [
                    el('div', {}, [
                        el('h2', { className: 'text-xl font-semibold text-slate-900' }, [currentProject?.name || 'Badenerstrasse 501']),
                        el('p', { className: 'text-sm text-slate-500 mt-1' }, [currentProject?.address || 'Badenerstrasse 501, 8048 Zürich'])
                    ]),
                    Badge({ status: currentProject?.status || 'active', label: currentProject?.statusLabel || 'Bewertung läuft' })
                ]),
                // Stats Grid
                el('div', { className: 'grid grid-cols-4 gap-4 mb-6' }, [
                    StatCard({ icon: 'apartment', value: String(currentProject?.variantCount || 5), label: 'Varianten' }),
                    StatCard({ icon: 'check_circle', value: String(currentProject?.evaluatedCount || 2), label: 'Bewertet' }),
                    StatCard({ icon: 'pending', value: String((currentProject?.variantCount || 5) - (currentProject?.evaluatedCount || 2)), label: 'In Arbeit' }),
                    StatCard({ icon: 'groups', value: String(teamMembers.length + experts.length), label: 'Teammitglieder' })
                ]),
                // Project Details
                el('div', { className: 'border-t border-slate-100 pt-5' }, [
                    el('div', { className: 'flex items-center justify-between mb-4' }, [
                        el('h3', { className: 'text-sm font-semibold text-slate-700 uppercase tracking-wide' }, ['Projektdetails']),
                        Button({ children: 'Bearbeiten', variant: 'ghost', size: 'sm', icon: 'edit' })
                    ]),
                    el('div', { className: 'grid grid-cols-3 gap-6' }, [
                        LabelValue({ label: 'Nutzungstyp', value: currentProject?.usageType || 'Wohnen' }),
                        LabelValue({ label: 'Bauphase SIA 102', value: currentProject?.phase || 'Vorprojekt' }),
                        LabelValue({ label: 'Framework', value: currentProject?.framework || 'SNAP' })
                    ])
                ])
            ])
        ]),
        // Evaluation Progress
        el('div', { className: 'card' }, [
            el('div', { className: 'card-body' }, [
                el('div', { className: 'flex items-center gap-3 mb-5' }, [
                    el('div', { className: 'collapsible-icon-wrapper' }, [Icon('assessment', { size: 18, className: 'text-slate-500' })]),
                    el('h3', { className: 'font-semibold text-slate-900' }, ['Bewertungsfortschritt'])
                ]),
                el('div', { className: 'grid grid-cols-2 gap-x-8 gap-y-4' }, Object.values(THEMES).map(theme =>
                    el('div', {}, [
                        el('div', { className: 'flex justify-between text-sm mb-1' }, [
                            el('span', { className: 'font-medium text-slate-700' }, [theme.name]),
                            el('span', { className: theme.progress === 100 ? 'text-emerald-600 font-medium' : 'text-slate-500' }, [`${theme.progress}%`])
                        ]),
                        ProgressBar({ value: theme.progress, color: theme.progress === 100 ? 'emerald' : 'amber' })
                    ])
                ))
            ])
        ]),
        // Map Section
        MapSection(),
        // Image Gallery Section
        ImageGallerySection(),
        // Team Section
        CollapsibleSection({
            id: 'team',
            icon: 'groups',
            title: 'Team',
            badge: `${teamMembers.length + experts.length} Mitglieder`,
            actions: [
                Button({ children: 'Einladen', variant: 'ghost', size: 'sm', icon: 'person_add' }),
                Button({ children: 'Bearbeiten', variant: 'ghost', size: 'sm', icon: 'edit' })
            ],
            children: [
                el('div', { className: 'section-subtitle' }, ['Projektteam']),
                el('div', { className: 'divide-y divide-slate-100' },
                    teamMembers.map(m => TeamMemberRow(m))
                ),
                el('div', { className: 'section-subtitle mt-6' }, ['Experten']),
                el('div', { className: 'divide-y divide-slate-100' },
                    experts.map(e => TeamMemberRow({ ...e, isExpert: true }))
                )
            ]
        }),
        // Timeline Section (Collapsible)
        CollapsibleSection({
            id: 'timeline',
            icon: 'schedule',
            title: 'Zeitplan',
            badge: `${milestones.filter(m => !m.done).length} offen`,
            actions: [
                Button({ children: 'Neuer Meilenstein', variant: 'ghost', size: 'sm', icon: 'add' })
            ],
            children: [
                el('div', { className: 'space-y-3' }, milestones.map(m =>
                    el('div', { className: `timeline-item ${m.done ? 'timeline-item-done' : 'timeline-item-pending'}` }, [
                        el('div', { className: `timeline-icon ${m.done ? 'timeline-icon-done' : 'timeline-icon-pending'}` }, [
                            Icon(m.done ? 'check' : 'schedule', { size: 16 })
                        ]),
                        el('div', { className: 'timeline-content' }, [
                            el('div', { className: `timeline-label ${m.done ? 'timeline-label-done' : ''}` }, [m.label]),
                            el('div', { className: 'timeline-date' }, [m.date])
                        ]),
                        !m.done ? Button({ children: 'Erledigt', variant: 'ghost', size: 'sm', icon: 'check' }) : null
                    ])
                ))
            ]
        })
    ]);
};

// ============================================
// EVALUATION VIEW COMPONENT
// ============================================
const EvaluationView = () => {
    const selectedVariant = store.get('selectedVariant');
    const expandedThemes = store.get('expandedThemes');
    const isEditMode = store.get('isEditMode');
    const variant = VARIANTS[selectedVariant];

    const toggleTheme = (themeId) => {
        const current = [...expandedThemes];
        const index = current.indexOf(themeId);
        if (index >= 0) current.splice(index, 1);
        else current.push(themeId);
        store.set('expandedThemes', current);
        renderApp();
    };

    // Variant Header
    const VariantHeader = () => el('div', { className: 'variant-header' }, [
        el('div', { className: 'variant-header-image' }, [
            el('img', { src: variant.thumbnail, alt: variant.name }),
            el('div', { className: 'variant-header-gradient' }),
            el('div', { className: 'variant-header-info' }, [
                el('div', { className: 'variant-header-name' }, [variant.name]),
                el('div', { className: 'variant-header-firm' }, [variant.firm])
            ]),
            el('span', { className: 'variant-header-code' }, [variant.code])
        ]),
        el('div', { className: 'variant-header-details' }, [
            el('div', { className: 'variant-metrics' }, [
                el('div', {}, [el('div', { className: 'variant-metric-value' }, ["7'816"]), el('div', { className: 'variant-metric-label' }, ['GF (m²)'])]),
                el('div', {}, [el('div', { className: 'variant-metric-value' }, ["23'332"]), el('div', { className: 'variant-metric-label' }, ['GV (m³)'])]),
                el('div', {}, [el('div', { className: 'variant-metric-value' }, ['0.64']), el('div', { className: 'variant-metric-label' }, ['NF/BGF'])]),
                el('div', {}, [el('div', { className: 'variant-metric-value' }, ['14']), el('div', { className: 'variant-metric-label' }, ['Geschosse'])])
            ]),
            el('div', { className: 'variant-meta' }, [
                el('div', { className: 'variant-meta-info' }, [
                    el('span', { className: 'text-slate-500' }, ['Eingereicht: ']),
                    el('span', { className: 'text-slate-700 font-medium' }, ['25.03.2023']),
                    el('span', { className: 'flex items-center gap-1' }, [
                        Icon('check_circle', { size: 14, className: 'text-emerald-500' }),
                        el('span', { className: 'text-slate-700 text-xs' }, ['BIM Modell'])
                    ])
                ])
            ])
        ])
    ]);

    // Theme Card
    const ThemeCard = (theme) => {
        const isExpanded = expandedThemes.includes(theme.id);
        const kennwerte = generateKennwertData(selectedVariant, theme.kennwerte);
        const kriterien = generateKriterienData(selectedVariant, theme.kriterien);
        const ratingCounts = kriterien.reduce((acc, k) => { acc[k.rating] = (acc[k.rating] || 0) + 1; return acc; }, {});

        return el('div', { className: `theme-card ${isExpanded ? 'expanded' : ''}` }, [
            el('button', { className: 'theme-card-header', onclick: () => toggleTheme(theme.id) }, [
                el('div', { className: 'theme-indicator' }),
                el('div', { className: 'theme-icon' }, [Icon(theme.icon, { size: 22, className: 'text-slate-500' })]),
                el('div', { className: 'theme-info' }, [
                    el('div', { className: 'theme-name' }, [theme.name]),
                    el('div', { className: 'theme-meta' }, [`${theme.kennwerte.length} Quantitativ · ${theme.kriterien.length} Qualitativ`])
                ]),
                el('div', { className: 'theme-ratings' }, [
                    ratingCounts.positive ? el('span', { className: 'theme-rating-badge' }, [Icon('thumb_up', { size: 14, className: 'text-emerald-500' }), ratingCounts.positive]) : null,
                    ratingCounts.neutral ? el('span', { className: 'theme-rating-badge' }, [Icon('sentiment_neutral', { size: 14, className: 'text-amber-500' }), ratingCounts.neutral]) : null,
                    ratingCounts.negative ? el('span', { className: 'theme-rating-badge' }, [Icon('thumb_down', { size: 14, className: 'text-red-500' }), ratingCounts.negative]) : null
                ]),
                el('div', { className: 'theme-progress' }, [
                    el('div', { className: 'theme-progress-bar' }, [
                        el('div', {
                            className: `theme-progress-fill ${theme.progress === 100 ? 'bg-emerald-500' : 'bg-slate-400'}`,
                            style: { width: `${theme.progress}%` }
                        })
                    ]),
                    el('span', { className: 'theme-progress-label' }, [`${theme.progress}%`])
                ]),
                Icon(isExpanded ? 'expand_less' : 'expand_more', { size: 20, className: 'text-slate-400' })
            ]),
            isExpanded ? el('div', { className: 'theme-card-content' }, [
                // Kennwerte Section
                el('div', { className: 'theme-section' }, [
                    el('div', { className: 'theme-section-header' }, [
                        el('h4', { className: 'theme-section-title' }, ['Quantitativ'])
                    ]),
                    el('div', { className: 'space-y-4' }, kennwerte.map(k =>
                        el('div', { className: 'kennwert-row' }, [
                            el('div', { className: 'kennwert-label' }, [k.label, k.unit ? el('span', { className: 'kennwert-unit' }, [` (${k.unit})`]) : null]),
                            el('div', { className: 'kennwert-bar-container' }, [
                                el('div', { className: 'kennwert-bar-wrapper' }, [
                                    el('span', { className: 'kennwert-avg-label', style: { left: `${k.avg}%` } }, [`Ø ${k.avg}${k.unit === '%' ? '%' : ''}`]),
                                    el('div', { className: 'kennwert-bar' }, [
                                        el('div', { className: 'kennwert-bar-fill', style: { width: `${Math.min(k.value, 100)}%` } }, [
                                            el('span', { className: 'kennwert-bar-value' }, [`${k.value}${k.unit === '%' ? ' %' : ''}`])
                                        ]),
                                        el('div', { className: 'kennwert-avg-marker', style: { left: `${k.avg}%` } })
                                    ])
                                ]),
                                el('div', { className: `kennwert-delta ${k.delta >= 0 ? 'kennwert-delta-positive' : 'kennwert-delta-negative'}` }, [`${k.delta >= 0 ? '+' : ''}${k.delta}%`]),
                                el('div', { className: 'kennwert-rank' }, [`${k.rank}/${k.total}`])
                            ])
                        ])
                    ))
                ]),
                // Kriterien Section
                el('div', { className: 'theme-section' }, [
                    el('div', { className: 'theme-section-header' }, [
                        el('h4', { className: 'theme-section-title' }, ['Qualitativ']),
                        Button({
                            children: isEditMode ? 'Speichern' : 'Bearbeiten',
                            variant: 'ghost', size: 'sm',
                            icon: isEditMode ? 'check' : 'edit',
                            onClick: (e) => { e.stopPropagation(); store.set('isEditMode', !isEditMode); renderApp(); }
                        })
                    ]),
                    el('div', { className: 'space-y-2' }, kriterien.map(k =>
                        el('div', { className: `criterion-row ${isEditMode ? 'editing' : ''}` }, [
                            isEditMode ?
                                el('div', { className: 'rating-selector' }, [
                                    el('button', {
                                        className: `rating-btn rating-btn-negative ${k.rating === 'negative' ? 'active' : ''}`,
                                        onclick: (e) => { e.stopPropagation(); updateRating(selectedVariant, k.id, 'negative'); }
                                    }, [Icon('thumb_down', { size: 18 })]),
                                    el('button', {
                                        className: `rating-btn rating-btn-neutral ${k.rating === 'neutral' ? 'active' : ''}`,
                                        onclick: (e) => { e.stopPropagation(); updateRating(selectedVariant, k.id, 'neutral'); }
                                    }, [Icon('sentiment_neutral', { size: 18 })]),
                                    el('button', {
                                        className: `rating-btn rating-btn-positive ${k.rating === 'positive' ? 'active' : ''}`,
                                        onclick: (e) => { e.stopPropagation(); updateRating(selectedVariant, k.id, 'positive'); }
                                    }, [Icon('thumb_up', { size: 18 })])
                                ]) :
                                el('div', { className: `rating-indicator rating-indicator-${k.rating}` }, [
                                    Icon(k.rating === 'positive' ? 'thumb_up' : k.rating === 'neutral' ? 'sentiment_neutral' : 'thumb_down', { size: 20 })
                                ]),
                            el('div', { className: 'criterion-content' }, [
                                el('div', { className: 'criterion-header' }, [
                                    el('span', { className: 'criterion-id' }, [k.id]),
                                    el('span', { className: 'criterion-name' }, [k.name])
                                ]),
                                k.desc ? el('div', { className: 'criterion-desc' }, [k.desc]) : null,
                                isEditMode ?
                                    el('textarea', {
                                        className: 'input mt-2',
                                        value: k.comment,
                                        placeholder: 'Anmerkungen eingeben...',
                                        onblur: (e) => updateComment(selectedVariant, k.id, e.target.value)
                                    }) :
                                    el('div', { className: 'criterion-comment mt-1' }, [k.comment])
                            ])
                        ])
                    ))
                ])
            ]) : null
        ]);
    };

    return el('div', { className: 'flex-1 space-y-4' }, [
        VariantHeader(),
        el('div', { className: 'flex items-center justify-between px-1' }, [
            el('h2', { className: 'text-lg font-semibold text-slate-900' }, ['SNAP Bewertung']),
            el('div', { className: 'flex items-center gap-2' }, [
                el('button', {
                    className: 'text-xs text-slate-500 hover\\:text-slate-700 px-2 py-1 hover\\:bg-slate-100 rounded-lg transition-colors border-0',
                    onclick: () => { store.set('expandedThemes', Object.keys(THEMES)); renderApp(); }
                }, ['Alle öffnen']),
                el('button', {
                    className: 'text-xs text-slate-500 hover\\:text-slate-700 px-2 py-1 hover\\:bg-slate-100 rounded-lg transition-colors border-0',
                    onclick: () => { store.set('expandedThemes', []); renderApp(); }
                }, ['Alle schließen'])
            ])
        ]),
        ...Object.values(THEMES).map(theme => ThemeCard(theme))
    ]);
};

const updateRating = (variantIndex, criterionId, newRating) => {
    const criteriaData = { ...store.get('criteriaData') };
    if (!criteriaData[variantIndex]) criteriaData[variantIndex] = {};
    criteriaData[variantIndex][criterionId] = { ...criteriaData[variantIndex][criterionId], rating: newRating };
    store.set('criteriaData', criteriaData);
    renderApp();
};

const updateComment = (variantIndex, criterionId, newComment) => {
    const criteriaData = { ...store.get('criteriaData') };
    if (!criteriaData[variantIndex]) criteriaData[variantIndex] = {};
    criteriaData[variantIndex][criterionId] = { ...criteriaData[variantIndex][criterionId], comment: newComment };
    store.set('criteriaData', criteriaData);
};

// ============================================
// COMPARISON VIEW COMPONENT
// ============================================
const ComparisonView = () => {
    const selectedVariantsForCompare = store.get('selectedVariantsForCompare');
    const filteredVariants = VARIANTS.filter((_, i) => selectedVariantsForCompare.includes(i));

    const getRating = (variantIndex, criterionId) => {
        const hash = (variantIndex * 17 + parseInt(criterionId) * 13) % 10;
        if (hash < 3) return 'negative';
        if (hash < 6) return 'neutral';
        return 'positive';
    };

    const quantData = [
        { id: 1, name: 'Geschossfläche GF', unit: 'm²', values: [7816, 7444, 7864, 8171, 7988, 7652] },
        { id: 2, name: 'Gebäudevolumen GV', unit: 'm³', values: [23332, 23210, 22202, 24644, 23920, 22890] },
        { id: 3, name: 'Flächeneffizienz NF/BGF', unit: '', values: [0.64, 0.66, 0.61, 0.61, 0.63, 0.62] },
        { id: 4, name: 'A/V-Verhältnis', unit: '', values: [0.29, 0.31, 0.28, 0.32, 0.30, 0.27] },
        { id: 5, name: 'Fensterflächenanteil', unit: '%', values: [47, 52, 44, 49, 51, 46] },
        { id: 6, name: 'Primärenergiebedarf', unit: '%', values: [107, 95, 112, 98, 103, 99], lowerIsBetter: true },
    ];

    return el('div', { className: 'comparison-wrapper overflow-x-auto' }, [
        el('table', { className: 'comparison-table', style: { tableLayout: 'fixed' } }, [
            el('thead', {}, [
                el('tr', {}, [
                    el('th', { className: 'comparison-sticky header text-left text-sm font-medium text-slate-600', style: { width: '256px' } }, ['Kriterium']),
                    ...filteredVariants.map(v => el('th', { className: 'text-center text-sm font-semibold text-slate-900', style: { width: '140px' } }, [v.code]))
                ])
            ]),
            el('tbody', {}, [
                // Images row
                el('tr', {}, [
                    el('td', { className: 'comparison-sticky' }),
                    ...filteredVariants.map(v => el('td', {}, [
                        el('div', { className: 'w-full h-20 rounded-lg bg-slate-200 overflow-hidden' }, [
                            el('img', { src: v.thumbnail, alt: v.name, className: 'w-full h-full object-cover' })
                        ])
                    ]))
                ]),
                // Summary row
                el('tr', { className: 'comparison-summary-row' }, [
                    el('td', { className: 'comparison-sticky text-sm font-semibold text-emerald-800' }, ['Gesamtbewertung']),
                    ...filteredVariants.map((v, i) => {
                        const score = 60 + (selectedVariantsForCompare[i] * 7) % 30;
                        return el('td', { className: 'text-center' }, [
                            el('div', { className: 'flex items-center justify-center gap-2' }, [
                                el('div', { className: 'w-16 h-2 bg-slate-200 rounded-full overflow-hidden' }, [
                                    el('div', { className: 'h-full bg-emerald-500 rounded-full', style: { width: `${score}%` } })
                                ]),
                                el('span', { className: 'text-sm font-semibold text-emerald-700' }, [`${score}%`])
                            ])
                        ]);
                    })
                ]),
                // Theme sections
                ...Object.values(THEMES).flatMap(theme => [
                    el('tr', { className: 'comparison-theme-row' }, [
                        el('td', { colspan: filteredVariants.length + 1 }, [theme.name])
                    ]),
                    ...theme.kriterien.map(criterion =>
                        el('tr', { className: 'hover\\:bg-slate-50' }, [
                            el('td', { className: 'comparison-sticky text-sm text-slate-700' }, [
                                el('span', { className: 'text-slate-400 mr-2' }, [criterion.id]),
                                criterion.name
                            ]),
                            ...filteredVariants.map((v, i) => {
                                const rating = getRating(selectedVariantsForCompare[i], parseInt(criterion.id));
                                const iconName = rating === 'positive' ? 'thumb_up' : rating === 'neutral' ? 'sentiment_neutral' : 'thumb_down';
                                const iconColor = rating === 'positive' ? 'text-emerald-500' : rating === 'neutral' ? 'text-amber-500' : 'text-red-500';
                                return el('td', { className: 'text-center' }, [
                                    el('div', { className: 'flex justify-center' }, [Icon(iconName, { size: 22, className: iconColor })])
                                ]);
                            })
                        ])
                    )
                ]),
                // Quantitative section
                el('tr', { className: 'comparison-theme-row' }, [
                    el('td', { colspan: filteredVariants.length + 1 }, ['Quantitativ'])
                ]),
                ...quantData.map(kw => {
                    const selectedValues = selectedVariantsForCompare.map(i => kw.values[i]);
                    const best = kw.lowerIsBetter ? Math.min(...selectedValues) : Math.max(...selectedValues);
                    return el('tr', { className: 'hover\\:bg-slate-50' }, [
                        el('td', { className: 'comparison-sticky text-sm text-slate-700' }, [
                            kw.name, kw.unit ? el('span', { className: 'text-slate-400' }, [` (${kw.unit})`]) : null
                        ]),
                        ...filteredVariants.map((v, i) => {
                            const value = kw.values[selectedVariantsForCompare[i]];
                            const isBest = value === best;
                            return el('td', { className: 'text-center' }, [
                                el('span', { className: `text-sm font-medium ${isBest ? 'comparison-best' : 'text-slate-700'}` }, [
                                    typeof value === 'number' && value % 1 !== 0 ? value.toFixed(2) : value.toLocaleString(),
                                    kw.unit === '%' ? '%' : ''
                                ]),
                                isBest ? el('span', { className: 'comparison-star' }, ['★']) : null
                            ]);
                        })
                    ]);
                })
            ])
        ]),
        el('div', { className: 'comparison-legend' }, [
            el('span', { className: 'font-medium' }, ['Legende:']),
            el('div', { className: 'comparison-legend-item' }, [Icon('thumb_up', { size: 20, className: 'text-emerald-500' }), 'Gut']),
            el('div', { className: 'comparison-legend-item' }, [Icon('sentiment_neutral', { size: 20, className: 'text-amber-500' }), 'Mittel']),
            el('div', { className: 'comparison-legend-item' }, [Icon('thumb_down', { size: 20, className: 'text-red-500' }), 'Schwach']),
            el('div', { className: 'comparison-legend-item ml-4' }, [el('span', { className: 'text-emerald-500 text-lg' }, ['★']), 'Bester Wert'])
        ])
    ]);
};

// ============================================
// 3D MODEL VIEW COMPONENT
// ============================================
const Model3DView = () => {
    const selectedVariant = store.get('selectedVariant');
    const variant = VARIANTS[selectedVariant];

    return el('div', { className: 'viewer-3d' }, [
        el('div', { className: 'viewer-toolbar' }, [
            el('div', { className: 'flex items-center gap-1' }, [
                el('button', { className: 'viewer-toolbar-btn' }, [Icon('restart_alt', { size: 16 }), 'Reset']),
                el('button', { className: 'viewer-toolbar-btn' }, [Icon('carpenter', { size: 16 }), 'Schnitt']),
                el('button', { className: 'viewer-toolbar-btn' }, [Icon('straighten', { size: 16 }), 'Messen']),
                el('div', { className: 'w-px h-6 bg-slate-200 mx-2' }),
                el('button', { className: 'viewer-toolbar-btn' }, [Icon('layers', { size: 16 }), 'Geschosse']),
                el('button', { className: 'viewer-toolbar-btn' }, [Icon('visibility', { size: 16 }), 'Sichtbarkeit'])
            ]),
            el('div', { className: 'flex items-center gap-2 text-sm text-slate-500' }, [
                Icon('description', { size: 16 }),
                'IFC Model',
                el('span', { className: 'text-slate-300' }, ['|']),
                'Hochgeladen: 25.03.2023'
            ])
        ]),
        el('div', { className: 'viewer-canvas' }, [
            // Fake 3D building
            el('div', { className: 'absolute inset-0 flex items-center justify-center' }, [
                el('div', { style: { perspective: '1000px' } }, [
                    el('div', {
                        className: 'relative',
                        style: { width: '256px', height: '320px', transformStyle: 'preserve-3d', transform: 'rotateX(-15deg) rotateY(-25deg)' }
                    }, [...Array(12)].map((_, i) =>
                        el('div', {
                            className: 'absolute w-full bg-gradient-to-r from-slate-600 to-slate-700 border border-slate-500',
                            style: { height: '20px', bottom: `${i * 22}px`, transform: 'translateZ(20px)', boxShadow: '4px 4px 0 rgba(0,0,0,0.3)' }
                        }, [
                            el('div', { className: 'absolute inset-1 flex gap-1' }, [...Array(8)].map(() =>
                                el('div', { className: 'flex-1 bg-amber-200', style: { opacity: Math.random() > 0.3 ? 0.7 : 0.2 } })
                            ))
                        ])
                    ))
                ])
            ]),
            el('div', { className: 'viewer-overlay viewer-info' }, [
                el('div', { className: 'font-medium' }, [variant.name]),
                el('div', { className: 'text-slate-300 text-xs' }, [variant.firm])
            ]),
            el('div', { className: 'viewer-overlay viewer-controls space-y-1' }, [
                el('div', { className: 'flex items-center gap-2' }, [Icon('mouse', { size: 14 }), 'Drehen: Linksklick + Ziehen']),
                el('div', { className: 'flex items-center gap-2' }, [Icon('zoom_in', { size: 14 }), 'Zoom: Scrollrad']),
                el('div', { className: 'flex items-center gap-2' }, [Icon('pan_tool', { size: 14 }), 'Verschieben: Rechtsklick'])
            ]),
            el('div', { className: 'viewer-overlay viewer-stats' }, [
                el('div', { className: 'text-xs text-slate-400 uppercase tracking-wide mb-2' }, ['Modell-Daten']),
                el('div', { className: 'grid grid-cols-2 gap-x-4 gap-y-1 text-sm' }, [
                    el('span', { className: 'text-slate-400' }, ['GF Total:']),
                    el('span', { className: 'font-medium' }, ["7'816 m²"]),
                    el('span', { className: 'text-slate-400' }, ['GV Total:']),
                    el('span', { className: 'font-medium' }, ["23'332 m³"]),
                    el('span', { className: 'text-slate-400' }, ['Geschosse:']),
                    el('span', { className: 'font-medium' }, ['14']),
                    el('span', { className: 'text-slate-400' }, ['Elemente:']),
                    el('span', { className: 'font-medium' }, ["12'847"])
                ])
            ])
        ])
    ]);
};

// ============================================
// CREATE MODAL COMPONENT
// ============================================
const CreateProjectModal = () => {
    const isOpen = store.get('isCreateModalOpen');
    const formErrors = store.get('formErrors');
    const isSubmitting = store.get('isSubmitting');

    if (!isOpen) return null;

    const close = () => {
        store.update({ isCreateModalOpen: false, formErrors: {}, isSubmitting: false });
        renderApp();
    };

    const validate = () => {
        const errors = {};
        const nameInput = document.getElementById('project-name');
        const usageSelect = document.getElementById('project-usage');
        const frameworkSelect = document.getElementById('project-framework');

        if (!nameInput?.value?.trim()) {
            errors.name = 'Projektname ist erforderlich';
        }
        if (!usageSelect?.value) {
            errors.usage = 'Bitte Nutzungstyp wählen';
        }
        if (!frameworkSelect?.value) {
            errors.framework = 'Bitte Framework wählen';
        }

        return errors;
    };

    const handleSubmit = () => {
        const errors = validate();
        if (Object.keys(errors).length > 0) {
            store.set('formErrors', errors);
            renderApp();
            return;
        }

        store.set('isSubmitting', true);
        renderApp();

        // Simulate API call
        setTimeout(() => {
            close();
        }, 1000);
    };

    const InputError = (message) => message ?
        el('p', { className: 'text-xs text-red-500 mt-1' }, [message]) : null;

    return el('div', { className: 'modal-backdrop', onclick: (e) => { if (e.target === e.currentTarget) close(); } }, [
        el('div', { className: 'modal' }, [
            el('div', { className: 'modal-header' }, [
                el('div', {}, [
                    el('h2', { className: 'modal-title' }, ['Neues Projekt erstellen']),
                    el('p', { className: 'modal-subtitle' }, ['Felder mit ', el('span', { className: 'text-red-500' }, ['*']), ' sind erforderlich'])
                ]),
                el('button', { className: 'modal-close', onclick: close }, [Icon('close', { size: 20 })])
            ]),
            el('div', { className: 'modal-body space-y-4' }, [
                el('div', { className: 'input-wrapper' }, [
                    el('label', { className: 'input-label' }, ['Projektname ', el('span', { className: 'input-required' }, ['*'])]),
                    el('input', {
                        type: 'text',
                        id: 'project-name',
                        className: `input ${formErrors.name ? 'border-red-500' : ''}`,
                        placeholder: 'z.B. Musterstrasse 123'
                    }),
                    InputError(formErrors.name)
                ]),
                el('div', { className: 'input-wrapper' }, [
                    el('label', { className: 'input-label' }, ['Adresse']),
                    el('input', { type: 'text', id: 'project-address', className: 'input', placeholder: 'Strasse, PLZ Ort' })
                ]),
                el('div', { className: 'grid grid-cols-2 gap-4' }, [
                    el('div', { className: 'input-wrapper' }, [
                        el('label', { className: 'input-label' }, ['Nutzungstyp ', el('span', { className: 'input-required' }, ['*'])]),
                        el('select', {
                            id: 'project-usage',
                            className: `input select ${formErrors.usage ? 'border-red-500' : ''}`
                        }, [
                            el('option', { value: '' }, ['Bitte wählen...']),
                            el('option', { value: 'Wohnen' }, ['Wohnen']),
                            el('option', { value: 'Büro / Gewerbe' }, ['Büro / Gewerbe']),
                            el('option', { value: 'Wohnen / Gewerbe' }, ['Wohnen / Gewerbe']),
                            el('option', { value: 'Stadion / Wohnen' }, ['Stadion / Wohnen']),
                            el('option', { value: 'Bildung' }, ['Bildung'])
                        ]),
                        InputError(formErrors.usage)
                    ]),
                    el('div', { className: 'input-wrapper' }, [
                        el('label', { className: 'input-label' }, ['Framework ', el('span', { className: 'input-required' }, ['*'])]),
                        el('select', {
                            id: 'project-framework',
                            className: `input select ${formErrors.framework ? 'border-red-500' : ''}`
                        }, [
                            el('option', { value: '' }, ['Bitte wählen...']),
                            el('option', { value: 'SNAP' }, ['SNAP']),
                            el('option', { value: 'SNBS' }, ['SNBS']),
                            el('option', { value: 'Minergie' }, ['Minergie']),
                            el('option', { value: 'Minergie-ECO' }, ['Minergie-ECO'])
                        ]),
                        InputError(formErrors.framework)
                    ])
                ]),
                el('div', { className: 'grid grid-cols-2 gap-4' }, [
                    el('div', { className: 'input-wrapper' }, [
                        el('label', { className: 'input-label' }, ['Bauphase SIA 102']),
                        el('select', { id: 'project-phase', className: 'input select' }, [
                            el('option', { value: '' }, ['Bitte wählen...']),
                            el('option', { value: 'Machbarkeit' }, ['Machbarkeit']),
                            el('option', { value: 'Vorprojekt' }, ['Vorprojekt']),
                            el('option', { value: 'Bauprojekt' }, ['Bauprojekt']),
                            el('option', { value: 'Realisierung' }, ['Realisierung'])
                        ])
                    ]),
                    el('div', { className: 'input-wrapper' }, [
                        el('label', { className: 'input-label' }, ['Geplante Varianten']),
                        el('input', { type: 'number', id: 'project-variants', className: 'input', placeholder: '5', min: '1', max: '20' })
                    ])
                ])
            ]),
            el('div', { className: 'modal-footer' }, [
                Button({ children: 'Abbrechen', variant: 'ghost', onClick: close, disabled: isSubmitting }),
                Button({
                    children: isSubmitting ? el('span', { className: 'flex items-center gap-2' }, [
                        el('span', { className: 'animate-spin', style: { display: 'inline-block' } }, ['⟳']),
                        'Erstellen...'
                    ]) : 'Projekt erstellen',
                    onClick: handleSubmit,
                    disabled: isSubmitting
                })
            ])
        ])
    ]);
};

// ============================================
// MAIN APP
// ============================================
const App = () => {
    const currentProject = store.get('currentProject');
    const sidebarView = store.get('sidebarView');
    const showVariantList = currentProject && sidebarView !== 'overview';

    // Gallery view
    if (!currentProject) {
        return el('div', { className: 'min-h-screen flex flex-col bg-slate-50' }, [
            AppHeader(),
            GalleryView(),
            CreateProjectModal()
        ]);
    }

    // Project view
    const getContentView = () => {
        switch (sidebarView) {
            case 'overview': return ProjectOverviewView();
            case 'evaluation': return EvaluationView();
            case 'comparison': return ComparisonView();
            case 'model3d': return Model3DView();
            default: return ProjectOverviewView();
        }
    };

    return el('div', { className: 'min-h-screen flex flex-col bg-slate-100' }, [
        AppHeader(),
        Breadcrumb(),
        el('div', { className: 'project-content' }, [
            el('div', { className: `project-layout ${sidebarView === 'comparison' ? 'comparison-view' : ''}` }, [
                MainSidebar(),
                el('div', { className: 'main-content' }, [
                    showVariantList ? VariantSelector() : null,
                    getContentView()
                ])
            ])
        ]),
        CreateProjectModal(),
        MobileSidebarOverlay(),
        MobileSidebarToggle()
    ]);
};

// ============================================
// RENDER
// ============================================
const renderApp = () => render(App, $('#root'));

// Initial render - load data first, then render
document.addEventListener('DOMContentLoaded', async () => {
    await loadAppData();
    renderApp();
});
    </script>
</body>
</html>
